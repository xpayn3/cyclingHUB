<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, viewport-fit=cover"
        />
        <title>CycleIQ — Training Dashboard</title>
        <link
            rel="icon"
            type="image/svg+xml"
            href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' fill='%2300e5a0'/%3E%3Cg stroke='%230d0f14' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none'%3E%3Ccircle cx='12' cy='12' r='7'/%3E%3Ccircle cx='12' cy='12' r='2'/%3E%3Cline x1='12' y1='5' x2='12' y2='10'/%3E%3Cline x1='12' y1='14' x2='12' y2='19'/%3E%3Cline x1='5' y1='12' x2='10' y2='12'/%3E%3Cline x1='14' y1='12' x2='19' y2='12'/%3E%3C/g%3E%3C/svg%3E"
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="styles.css" />
        <script>
            // Apply saved theme immediately to avoid flash of dark theme
            (function(){var t=localStorage.getItem('icu_theme');if(t)document.documentElement.setAttribute('data-theme',t)})();
        </script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
        />
        <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script defer src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
        <script defer src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
        <!-- FIT parser loaded on-demand in app.js (not needed at startup) -->
        <script src="app.js" defer></script>
    </head>
    <body>
        <!-- ============================================================  CONNECT MODAL  ============================================================ -->
        <div class="modal-backdrop" id="connectModal" role="dialog" aria-modal="true" aria-labelledby="connectModalTitle">
            <div class="modal">
                <div class="modal-header">
                    <div>
                        <div class="modal-header-icon">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <path
                                    d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
                                />
                                <path
                                    d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
                                />
                            </svg>
                        </div>
                        <div class="modal-title" id="connectModalTitle">Connect to intervals.icu</div>
                        <div class="modal-desc">
                            Enter your Athlete ID and API key to sync your
                            training data.
                        </div>
                    </div>
                    <button
                        class="modal-close"
                        id="modalCloseBtn"
                        onclick="closeModal()"
                        aria-label="Close"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2.5"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="callout">
                        <strong>How to find your credentials:</strong>
                        <ol>
                            <li>
                                Go to
                                <a href="https://intervals.icu" target="_blank" rel="noopener noreferrer"
                                    >intervals.icu</a
                                >
                                → Settings → API
                            </li>
                            <li>
                                Copy your <strong>Athlete ID</strong> (starts
                                with <code>i</code>, e.g. <code>i12345</code>)
                            </li>
                            <li>
                                Click <strong>Show API Key</strong> and copy it
                            </li>
                        </ol>
                    </div>

                    <div class="field">
                        <label for="inputAthleteId">Athlete ID</label>
                        <input
                            type="text"
                            id="inputAthleteId"
                            placeholder="e.g. i12345"
                            autocomplete="off"
                        />
                        <div class="field-hint">
                            Your profile ID from intervals.icu (visible in the
                            URL)
                        </div>
                        <div class="field-error" id="errAthleteId">
                            Please enter your Athlete ID
                        </div>
                    </div>

                    <div class="field">
                        <label for="inputApiKey">API Key</label>
                        <div class="input-with-toggle">
                            <input
                                type="password"
                                id="inputApiKey"
                                placeholder="Paste your API key here"
                                autocomplete="off"
                            />
                            <button
                                class="toggle-visibility"
                                onclick="toggleApiKeyVisibility()"
                                id="apiKeyToggle"
                                title="Show/hide API key"
                            >
                                <svg
                                    id="eyeIcon"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                                    />
                                    <circle cx="12" cy="12" r="3" />
                                </svg>
                            </button>
                        </div>
                        <div class="field-hint">
                            Found in intervals.icu → Settings → API → Show API
                            Key. Stored only in your browser.
                        </div>
                        <div class="field-error" id="errApiKey">
                            Please enter your API key
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-ghost" onclick="closeModal()">
                            Cancel
                        </button>
                        <button
                            class="btn btn-primary"
                            id="connectBtn"
                            onclick="handleConnect()"
                        >
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2.5"
                            >
                                <polyline points="20 6 9 17 4 12" />
                            </svg>
                            Connect &amp; Sync
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================  GEAR MODAL  ============================================================ -->
        <div class="modal-backdrop" id="gearModal" role="dialog" aria-modal="true" aria-labelledby="gearModalTitle" onclick="if(event.target===this)closeGearModal()">
            <div class="modal" style="max-width: 520px">
                <div class="modal-header">
                    <div>
                        <div class="modal-header-icon">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                width="22"
                                height="22"
                            >
                                <circle cx="12" cy="12" r="3" />
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
                                <path d="M4.93 4.93a10 10 0 0 0 0 14.14" />
                            </svg>
                        </div>
                        <div class="modal-title" id="gearModalTitle">
                            Add Component
                        </div>
                        <div class="modal-desc">
                            Track a bike part — brand, install date, and when to
                            replace it.
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeGearModal()" aria-label="Close">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2.5"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="gearEditId" />
                    <div class="gear-form-grid">
                        <div class="field">
                            <label for="gearFormBike">Bike</label>
                            <select id="gearFormBike" class="app-select">
                                <option value="">
                                    — All bikes / General —
                                </option>
                            </select>
                        </div>
                        <div class="field">
                            <label for="gearFormCategory">Category</label>
                            <select id="gearFormCategory" class="app-select">
                                <option>Drivetrain</option>
                                <option>Wheels</option>
                                <option>Cockpit</option>
                                <option>Frame</option>
                                <option>Brakes</option>
                                <option>Tyres</option>
                                <option>Pedals</option>
                                <option>Saddle</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="field">
                            <label for="gearFormName">Component Name</label>
                            <input
                                type="text"
                                id="gearFormName"
                                placeholder="e.g. Chain, Front tyre, Saddle…"
                            />
                        </div>
                        <div class="field">
                            <label for="gearFormBrand">Brand</label>
                            <input
                                type="text"
                                id="gearFormBrand"
                                placeholder="e.g. Shimano, Continental…"
                            />
                        </div>
                        <div class="field">
                            <label for="gearFormModel">Model</label>
                            <input
                                type="text"
                                id="gearFormModel"
                                placeholder="e.g. Dura-Ace CN-HG901"
                            />
                        </div>
                        <div class="field">
                            <label for="gearFormDate">Purchase Date</label>
                            <input type="date" id="gearFormDate" />
                        </div>
                        <div class="field">
                            <label for="gearFormPrice">Price (€)</label>
                            <input
                                type="number"
                                id="gearFormPrice"
                                placeholder="0"
                                min="0"
                                step="0.01"
                            />
                        </div>
                        <div class="field">
                            <label for="gearFormKmAtInstall">Bike km at Install</label>
                            <input
                                type="number"
                                id="gearFormKmAtInstall"
                                placeholder="0"
                                min="0"
                                step="1"
                            />
                            <div class="field-hint">
                                Total km on the bike when this component was
                                installed.
                            </div>
                        </div>
                        <div class="field" style="grid-column: 1/-1">
                            <label for="gearFormReminderKm">Maintenance Reminder (km)</label>
                            <input
                                type="number"
                                id="gearFormReminderKm"
                                placeholder="e.g. 2000 for chain"
                                min="0"
                                step="100"
                            />
                            <div class="field-hint">
                                Get a warning badge when this component reaches
                                this km threshold.
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 8px">
                        <button
                            class="btn btn-primary"
                            style="flex: 1"
                            onclick="submitGearForm()"
                        >
                            Save Component
                        </button>
                        <button
                            class="btn btn-ghost"
                            onclick="closeGearModal()"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Battery Modal -->
        <div class="modal-backdrop" id="batteryModal" role="dialog" aria-modal="true" aria-labelledby="batteryModalTitle" onclick="if(event.target===this)closeBatteryModal()">
            <div class="modal" style="max-width:520px">
                <div class="modal-header">
                    <div>
                        <div class="modal-header-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
                                <rect x="6" y="4" width="12" height="18" rx="2"/>
                                <line x1="10" y1="1" x2="14" y2="1" stroke-width="3" stroke-linecap="round"/>
                                <rect x="8" y="12" width="8" height="8" rx="1" fill="currentColor" opacity="0.3"/>
                            </svg>
                        </div>
                        <div class="modal-title" id="batteryModalTitle">Add Battery</div>
                        <div class="modal-desc">Track an electronic shifting battery or power pack.</div>
                    </div>
                    <button class="modal-close" onclick="closeBatteryModal()" aria-label="Close">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="batteryEditId">
                    <div class="gear-form-grid">
                        <div class="field">
                            <label for="batteryFormBike">BIKE</label>
                            <select id="batteryFormBike" class="app-select">
                                <option value="">— Select bike —</option>
                            </select>
                        </div>
                        <div class="field">
                            <label for="batteryFormSystem">SYSTEM</label>
                            <select id="batteryFormSystem" class="app-select" onchange="onBatterySystemChange()">
                                <option value="">— Select system —</option>
                            </select>
                        </div>
                        <div class="field">
                            <label for="batteryFormComponent">COMPONENT</label>
                            <select id="batteryFormComponent" class="app-select" onchange="onBatteryComponentChange()">
                                <option value="">— Select component —</option>
                            </select>
                        </div>
                        <div class="field">
                            <label for="batteryFormName">DISPLAY NAME</label>
                            <input type="text" id="batteryFormName" placeholder="e.g. Rear Derailleur Battery">
                        </div>
                        <div class="field">
                            <label for="batteryFormChargeDate">LAST CHARGED / REPLACED</label>
                            <input type="date" id="batteryFormChargeDate">
                        </div>
                        <div class="field">
                            <label for="batteryFormInstallDate">INSTALL DATE</label>
                            <input type="date" id="batteryFormInstallDate">
                        </div>
                        <div class="field" id="batteryRatedHoursField">
                            <label for="batteryFormRatedHours">RATED LIFE (HOURS)</label>
                            <input type="number" id="batteryFormRatedHours" placeholder="60" min="1" step="1">
                            <div class="field-hint">Manufacturer-rated riding hours per charge</div>
                        </div>
                        <div class="field" id="batteryRatedKmField" style="display:none">
                            <label for="batteryFormRatedKm">RATED LIFE (KM)</label>
                            <input type="number" id="batteryFormRatedKm" placeholder="1000" min="1" step="100">
                            <div class="field-hint">Manufacturer-rated km per charge</div>
                        </div>
                        <div class="field" style="grid-column:1/-1">
                            <label for="batteryFormNotes">NOTES</label>
                            <input type="text" id="batteryFormNotes" placeholder="Optional notes...">
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:8px">
                        <button class="btn btn-primary" style="flex:1" onclick="submitBatteryForm()">Save Battery</button>
                        <button class="btn btn-ghost" onclick="closeBatteryModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== SERVICE MODAL ==================== -->
        <div class="modal-backdrop" id="serviceModal" role="dialog" aria-modal="true" aria-labelledby="serviceModalTitle" onclick="if(event.target===this)closeServiceModal()">
            <div class="modal" style="max-width:560px">
                <div class="modal-header">
                    <div>
                        <div class="modal-header-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
                                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                            </svg>
                        </div>
                        <div class="modal-title" id="serviceModalTitle">Add Service</div>
                        <div class="modal-desc">Record a bike service — what was done, where, and when it's next due.</div>
                    </div>
                    <button class="modal-close" onclick="closeServiceModal()" aria-label="Close">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="serviceEditId">
                    <div class="gear-form-grid">
                        <div class="field">
                            <label for="serviceFormBike">Bike</label>
                            <select id="serviceFormBike" class="app-select"><option value="">— Select bike —</option></select>
                        </div>
                        <div class="field">
                            <label for="serviceFormShop">Service Shop</label>
                            <select id="serviceFormShop" class="app-select" onchange="onServiceShopChange()">
                                <option value="">— Select or enter below —</option>
                                <option value="__new__">+ Add New Shop…</option>
                            </select>
                        </div>
                        <div class="field" id="serviceShopNameField">
                            <label for="serviceFormShopName">Shop Name</label>
                            <input type="text" id="serviceFormShopName" placeholder="e.g. BikeWorld Service">
                        </div>
                        <div class="field" id="serviceShopPhoneField">
                            <label for="serviceFormShopPhone">Shop Phone</label>
                            <input type="tel" id="serviceFormShopPhone" placeholder="+386 1 234 5678">
                        </div>
                        <div class="field">
                            <label for="serviceFormDate">Service Date</label>
                            <input type="date" id="serviceFormDate">
                        </div>
                        <div class="field">
                            <label for="serviceFormCost">Cost (EUR)</label>
                            <input type="number" id="serviceFormCost" placeholder="0" min="0" step="0.01">
                        </div>
                        <div class="field" style="grid-column:1/-1">
                            <label for="serviceFormWork">Work Performed</label>
                            <textarea id="serviceFormWork" rows="2" placeholder="e.g. Full drivetrain service, brake bleed, new cables…"></textarea>
                        </div>
                        <div class="field" style="grid-column:1/-1">
                            <label for="serviceFormNotes">Notes</label>
                            <input type="text" id="serviceFormNotes" placeholder="Optional notes…">
                        </div>
                        <div class="field">
                            <label for="serviceFormNextMode">Next Service Due By</label>
                            <select id="serviceFormNextMode" class="app-select" onchange="onServiceNextModeChange()">
                                <option value="">— No reminder —</option>
                                <option value="km">Kilometers</option>
                                <option value="months">Months</option>
                            </select>
                        </div>
                        <div class="field" id="serviceNextKmField" style="display:none">
                            <label for="serviceFormNextKm">Service Every (km)</label>
                            <input type="number" id="serviceFormNextKm" placeholder="e.g. 3000" min="100" step="100">
                            <div class="field-hint">Service again after this many km ridden.</div>
                        </div>
                        <div class="field" id="serviceNextMonthsField" style="display:none">
                            <label for="serviceFormNextMonths">Service Every (months)</label>
                            <input type="number" id="serviceFormNextMonths" placeholder="e.g. 6" min="1" step="1">
                            <div class="field-hint">Service again after this many months.</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:8px">
                        <button class="btn btn-primary" style="flex:1" onclick="submitServiceForm()">Save Service</button>
                        <button class="btn btn-ghost" onclick="closeServiceModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== SERVICE SHOP MODAL ==================== -->
        <div class="modal-backdrop" id="serviceShopModal" role="dialog" aria-modal="true" aria-labelledby="serviceShopModalTitle" onclick="if(event.target===this)closeServiceShopModal()">
            <div class="modal" style="max-width:480px">
                <div class="modal-header">
                    <div>
                        <div class="modal-header-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                        </div>
                        <div class="modal-title" id="serviceShopModalTitle">Service Shops</div>
                        <div class="modal-desc">Your saved bike shops. Add shops here or when logging a service.</div>
                    </div>
                    <button class="modal-close" onclick="closeServiceShopModal()" aria-label="Close">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="serviceShopList"></div>
                    <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:14px">
                        <input type="hidden" id="shopEditId">
                        <div class="gear-form-grid">
                            <div class="field">
                                <label for="shopFormName">Shop Name</label>
                                <input type="text" id="shopFormName" placeholder="e.g. Bike House">
                            </div>
                            <div class="field">
                                <label for="shopFormPhone">Phone</label>
                                <input type="tel" id="shopFormPhone" placeholder="+386 1 234 5678">
                            </div>
                            <div class="field" style="grid-column:1/-1">
                                <label for="shopFormAddress">Address</label>
                                <input type="text" id="shopFormAddress" placeholder="Optional">
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm" style="margin-top:8px" onclick="saveServiceShop()">Save Shop</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== SERVICE HISTORY MODAL ==================== -->
        <div class="modal-backdrop" id="serviceHistoryModal" role="dialog" aria-modal="true" aria-labelledby="serviceHistoryTitle" onclick="if(event.target===this)closeServiceHistory()">
            <div class="modal" style="max-width:560px;max-height:80vh;display:flex;flex-direction:column">
                <div class="modal-header">
                    <div>
                        <div class="modal-header-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                            </svg>
                        </div>
                        <div class="modal-title" id="serviceHistoryTitle">Service History</div>
                        <div class="modal-desc" id="serviceHistoryDesc">All services for this bike</div>
                    </div>
                    <button class="modal-close" onclick="closeServiceHistory()" aria-label="Close">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y:auto;flex:1">
                    <div id="serviceHistoryList"></div>
                </div>
            </div>
        </div>

        <!-- ============================================================  SIDEBAR  ============================================================ -->
        <div
            class="sidebar-backdrop"
            id="sidebarBackdrop"
            onclick="closeSidebar()"
        ></div>
        <aside class="sidebar" id="sidebar" aria-label="Sidebar">
            <div
                class="sidebar-logo"
                onclick="navigate('dashboard')"
                style="cursor: pointer"
            >
                <div class="logo-icon">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#0d0f14"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="12" cy="12" r="9" />
                        <circle cx="12" cy="12" r="2" />
                        <line x1="12" y1="3" x2="12" y2="10" />
                        <line x1="12" y1="14" x2="12" y2="21" />
                        <line x1="3" y1="12" x2="10" y2="12" />
                        <line x1="14" y1="12" x2="21" y2="12" />
                    </svg>
                </div>
                <div class="logo-text">Cycle<span>IQ</span></div>
            </div>
            <nav class="sidebar-nav" aria-label="Main navigation">
                <span class="nav-section-label">Training</span>
                <div
                    class="nav-item active"
                    data-page="dashboard"
                    onclick="
                        navigate('dashboard');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                    Dashboard
                </div>
                <div
                    class="nav-item"
                    data-page="activities"
                    onclick="
                        navigate('activities');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                    </svg>
                    Activities
                </div>
                <div
                    class="nav-item"
                    data-page="calendar"
                    onclick="
                        navigate('calendar');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <rect x="3" y="4" width="18" height="18" rx="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                    Calendar
                </div>
                <div
                    class="nav-item"
                    data-page="fitness"
                    onclick="
                        navigate('fitness');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                    </svg>
                    Fitness
                    <span class="badge" id="sidebarCTL">—</span>
                </div>
                <div
                    class="nav-item"
                    data-page="goals"
                    onclick="
                        navigate('goals');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="12" cy="12" r="10" />
                        <circle cx="12" cy="12" r="6" />
                        <circle cx="12" cy="12" r="2" />
                    </svg>
                    Goals & Streaks
                </div>
                <span class="nav-section-label">Analysis</span>
                <div
                    class="nav-item"
                    data-page="power"
                    onclick="
                        navigate('power');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <polygon
                            points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                        />
                    </svg>
                    Power Curve
                </div>
                <div
                    class="nav-item"
                    data-page="zones"
                    onclick="
                        navigate('zones');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="12" cy="12" r="10" />
                        <path d="M12 8v4l3 3" />
                    </svg>
                    Training Zones
                </div>
                <div
                    class="nav-item"
                    data-page="compare"
                    onclick="
                        navigate('compare');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M3 3v18h18M3 18l6-6 4 4 6-6" />
                    </svg>
                    Compare
                </div>
                <div
                    class="nav-item"
                    data-page="heatmap"
                    onclick="
                        navigate('heatmap');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path
                            d="M12 2c-4 4-8 7.5-8 12a8 8 0 1 0 16 0c0-4.5-4-8-8-12z"
                        />
                        <path
                            d="M12 12a2.5 2.5 0 0 0-2.5 2.5c0 1.5 2.5 3.5 2.5 3.5s2.5-2 2.5-3.5A2.5 2.5 0 0 0 12 12z"
                        />
                    </svg>
                    Heat Map
                </div>
                <span class="nav-section-label">Tools</span>
                <div
                    class="nav-item"
                    data-page="weather"
                    onclick="
                        navigate('weather');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path
                            d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"
                        />
                        <path
                            d="M22 10a3 3 0 0 0-3-3h-1a5 5 0 1 0-9.33 2.5"
                            opacity=".4"
                        />
                    </svg>
                    Weather
                </div>
                <div
                    class="nav-item"
                    data-page="guide"
                    onclick="
                        navigate('guide');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="12" cy="12" r="10" />
                        <path d="M12 16v-4M12 8h.01" />
                    </svg>
                    Training Guide
                </div>
                <div
                    class="nav-item"
                    data-page="gear"
                    onclick="
                        navigate('gear');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="12" cy="12" r="3" />
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
                        <path d="M4.93 4.93a10 10 0 0 0 0 14.14" />
                        <path
                            d="M12 2v2M12 20v2M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41"
                        />
                    </svg>
                    Gear
                </div>
                <div
                    class="nav-item"
                    data-page="import"
                    onclick="
                        navigate('import');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    Import
                </div>
                <span class="nav-section-label">Account</span>
                <div
                    class="nav-item"
                    data-page="settings"
                    onclick="
                        navigate('settings');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"
                        />
                    </svg>
                    Settings
                </div>
            </nav>
            <div class="sidebar-footer">
                <button
                    class="sidebar-create-btn"
                    onclick="
                        navigate('workout');
                        closeSidebar();
                    "
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                    Create Workout
                </button>
                <div
                    class="athlete-chip"
                    onclick="openModal()"
                    title="Manage connection"
                >
                    <div class="athlete-avatar" id="athleteAvatar">?</div>
                    <div class="athlete-info">
                        <div class="athlete-name" id="athleteName">
                            Not connected
                        </div>
                        <div class="athlete-sub" id="athleteSub">
                            Click to connect
                        </div>
                    </div>
                    <div
                        class="connection-dot disconnected"
                        id="connectionDot"
                    ></div>
                </div>
                <div class="sidebar-actions">
                    <button
                        class="btn btn-ghost sidebar-action-btn"
                        id="syncBtn"
                        onclick="syncData()"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <polyline points="23 4 23 10 17 10" />
                            <path d="M20.49 15a9 9 0 1 1-.08-8.58" />
                        </svg>
                        Sync
                    </button>
                </div>
            </div>
        </aside>

        <!-- ============================================================  MAIN  ============================================================ -->
        <main class="main">
            <header class="topbar">
                <button
                    class="burger-btn"
                    id="burgerBtn"
                    onclick="toggleSidebar()"
                    aria-label="Menu"
                >
                    <span></span><span></span><span></span>
                </button>
                <!-- Month label — shown on the LEFT only on the calendar page -->
                <span
                    class="topbar-month-label"
                    id="calTopbarMonth"
                    style="display: none"
                ></span>
                <!-- Back button — shown on the LEFT only when viewing a single activity -->
                <button
                    class="btn btn-ghost detail-topbar-back"
                    id="detailTopbarBack"
                    onclick="navigateBack()"
                    style="display: none"
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        width="16"
                        height="16"
                    >
                        <polyline points="15 18 9 12 15 6" />
                    </svg>
                    Back
                </button>
                <!-- Back button — shown when viewing weather day detail -->
                <button
                    class="btn btn-ghost detail-topbar-back"
                    id="wxdTopbarBack"
                    onclick="navigate('dashboard')"
                    style="display: none"
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        width="16"
                        height="16"
                    >
                        <polyline points="15 18 9 12 15 6" />
                    </svg>
                    Back
                </button>
                <!-- Back button — shown on the settings page -->
                <button
                    class="btn btn-ghost detail-topbar-back"
                    id="settingsTopbarBack"
                    onclick="navigateBack()"
                    style="display: none"
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        width="16"
                        height="16"
                    >
                        <polyline points="15 18 9 12 15 6" />
                    </svg>
                    Back
                </button>
                <!-- Refresh — shown on the LEFT only on the weather page -->
                <button
                    class="btn btn-ghost wx-topbar-refresh"
                    id="wxTopbarRefresh"
                    onclick="refreshWeatherPage()"
                    style="display: none"
                    title="Refresh weather data"
                >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" width="15" height="15">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Refresh
                </button>
                <div class="topbar-actions">
                    <div class="date-range-pill" id="dateRangePill">
                        <button onclick="setRange(7)" id="range7">7d</button>
                        <button
                            onclick="setRange(30)"
                            id="range30"
                            class="active"
                        >
                            30d
                        </button>
                        <button onclick="setRange(90)" id="range90">90d</button>
                        <button onclick="setRange(365)" id="range365">
                            1y
                        </button>
                    </div>
                    <div class="date-range-pill" id="zoneRangePill" style="display:none">
                        <button data-zdays="7" onclick="setZnpRange(7)">7d</button>
                        <button class="active" data-zdays="30" onclick="setZnpRange(30)">30d</button>
                        <button data-zdays="90" onclick="setZnpRange(90)">90d</button>
                        <button data-zdays="365" onclick="setZnpRange(365)">1y</button>
                    </div>
                    <!-- Prev/next arrows — shown on the RIGHT only when viewing a single activity -->
                    <div
                        class="detail-nav-arrows"
                        id="detailTopbarNav"
                        style="display: none"
                    >
                        <button
                            class="btn btn-ghost detail-nav-btn"
                            id="detailNavPrev"
                            onclick="stepActivity(-1)"
                            title="Newer activity"
                            disabled
                        >
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                width="16"
                                height="16"
                            >
                                <polyline points="15 18 9 12 15 6" />
                            </svg>
                        </button>
                        <span
                            class="detail-nav-counter"
                            id="detailNavCounter"
                        ></span>
                        <button
                            class="btn btn-ghost detail-nav-btn"
                            id="detailNavNext"
                            onclick="stepActivity(1)"
                            title="Older activity"
                            disabled
                        >
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                width="16"
                                height="16"
                            >
                                <polyline points="9 18 15 12 9 6" />
                            </svg>
                        </button>
                    </div>
                </div>
            </header>
            <div class="page-content" id="pageContent">
                <div class="topbar-glow-el"></div>
                <!-- ── Page headline ── -->
                <div class="page-headline">
                    <div class="page-headline-title" id="pageTitle">
                        Dashboard
                    </div>
                    <div class="page-headline-sub" id="pageSubtitle">
                        Overview · Last 30 days
                    </div>
                </div>

                <!-- ==================== DASHBOARD ==================== -->
                <div class="page" id="page-dashboard">
                    <!-- ── Recent Activities ── -->
                    <div data-dash-section="recentCarousel">
                        <div
                            class="section-label"
                            id="recentActSectionLabel"
                            style="display: none"
                        >
                            Recent activities
                        </div>
                        <div
                            class="recent-act-scroll-rail"
                            id="recentActScrollRail"
                        ></div>
                    </div>

                    <!-- ── Week Progress + Training Status (side by side) ── -->
                    <div data-dash-section="weekProgress">
                        <div class="card-row">
                            <!-- Training Status card -->
                            <div
                                class="card trs-hero-card"
                                id="trainingStatusCard"
                            >
                                <!-- Hero header -->
                                <div class="trs-hero-header">
                                    <div class="trs-hero-titles">
                                        <div class="trs-hero-title">
                                            Training Status
                                        </div>
                                        <div class="trs-hero-sub">
                                            Your readiness at a glance
                                        </div>
                                    </div>
                                    <div
                                        id="trsFormStatus"
                                        class="trs-form-status"
                                    >
                                        —
                                    </div>
                                </div>

                                <!-- Gauge section -->
                                <div class="trs-gauge-section">
                                    <div class="trs-gauge-glow-wrap">
                                        <div class="trs-gauge-container">
                                            <svg
                                                id="rampGaugeSVG"
                                                viewBox="0 0 200 116"
                                                class="trs-gauge-svg"
                                            ></svg>
                                            <div class="trs-gauge-overlay">
                                                <div
                                                    class="trs-gauge-num"
                                                    id="rampNum"
                                                >
                                                    —
                                                </div>
                                                <div class="trs-gauge-unit">
                                                    CTL / wk
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="trs-ramp-meta">
                                        <div id="rampBadge" class="trs-badge">
                                            —
                                        </div>
                                        <div
                                            class="trs-form-hint"
                                            id="trsFormHint"
                                        >
                                            —
                                        </div>
                                    </div>
                                </div>

                                <!-- CTL / ATL / TSB tiles -->
                                <div class="trs-metrics-row">
                                    <div class="trs-metric-tile">
                                        <div
                                            class="trs-metric-val"
                                            id="trsCTLNum"
                                        >
                                            —
                                        </div>
                                        <div class="trs-metric-name">CTL</div>
                                        <div class="trs-metric-desc">
                                            Fitness
                                        </div>
                                    </div>
                                    <div class="trs-metrics-sep"></div>
                                    <div class="trs-metric-tile">
                                        <div
                                            class="trs-metric-val"
                                            id="trsATLNum"
                                        >
                                            —
                                        </div>
                                        <div class="trs-metric-name">ATL</div>
                                        <div class="trs-metric-desc">
                                            Fatigue
                                        </div>
                                    </div>
                                    <div class="trs-metrics-sep"></div>
                                    <div class="trs-metric-tile">
                                        <div
                                            class="trs-metric-val trs-metric-val--form"
                                            id="trsFormNum"
                                        >
                                            —
                                        </div>
                                        <div class="trs-metric-name">TSB</div>
                                        <div class="trs-metric-desc">Form</div>
                                    </div>
                                </div>

                                <!-- Aerobic Efficiency sparkline -->
                                <div class="trs-ef-wrap">
                                    <div class="trs-ef-header">
                                        <div class="trs-metric-label">
                                            Aerobic Efficiency · NP ÷ HR
                                        </div>
                                        <div class="trs-ef-nums">
                                            <span id="trsEFCurrent">—</span>
                                            <span id="trsEFDelta">—</span>
                                        </div>
                                    </div>
                                    <div class="trs-ef-chart-area">
                                        <canvas id="trsEFChart"></canvas>
                                    </div>
                                    <div class="trs-ef-footer">
                                        Last 10 qualifying rides with power + HR
                                        · higher = more efficient
                                    </div>
                                </div>
                            </div>

                            <div class="card" id="weekProgressCard">
                                <div class="card-header">
                                    <div>
                                        <div class="card-title">
                                            Week Progress
                                        </div>
                                        <div
                                            class="card-subtitle"
                                            id="wpSubtitle"
                                        >
                                            Training Load · Mon → Sun
                                        </div>
                                    </div>
                                    <div class="wkp-header-right">
                                        <div class="wkp-toggles">
                                            <button
                                                class="wkp-toggle-btn wkp-toggle-btn--active"
                                                data-metric="tss"
                                                onclick="
                                                    renderWeekProgress('tss')
                                                "
                                            >
                                                Load
                                            </button>
                                            <button
                                                class="wkp-toggle-btn"
                                                data-metric="distance"
                                                onclick="
                                                    renderWeekProgress(
                                                        'distance',
                                                    )
                                                "
                                            >
                                                Distance
                                            </button>
                                            <button
                                                class="wkp-toggle-btn"
                                                data-metric="time"
                                                onclick="
                                                    renderWeekProgress('time')
                                                "
                                            >
                                                Time
                                            </button>
                                            <button
                                                class="wkp-toggle-btn"
                                                data-metric="elevation"
                                                onclick="
                                                    renderWeekProgress(
                                                        'elevation',
                                                    )
                                                "
                                            >
                                                Elevation
                                            </button>
                                        </div>
                                        <div class="chart-legend">
                                            <span class="chart-legend-item"
                                                ><span
                                                    class="chart-legend-dot"
                                                    style="
                                                        background: var(
                                                            --accent
                                                        );
                                                    "
                                                ></span
                                                >This week</span
                                            >
                                            <span class="chart-legend-item"
                                                ><span
                                                    class="chart-legend-dot"
                                                    style="
                                                        background: rgba(
                                                            136,
                                                            145,
                                                            168,
                                                            0.5
                                                        );
                                                    "
                                                ></span
                                                >Last week</span
                                            >
                                        </div>
                                    </div>
                                </div>
                                <div class="wkp-body">
                                    <div class="wkp-chart">
                                        <canvas id="weekProgressChart"></canvas>
                                    </div>
                                    <div class="wkp-stats">
                                        <div class="wkp-stat">
                                            <div class="wkp-stat-label">
                                                This week
                                            </div>
                                            <div
                                                class="wkp-stat-val"
                                                id="wpThisWeek"
                                            >
                                                —
                                            </div>
                                            <div
                                                class="wkp-stat-delta"
                                                id="wpDelta"
                                            >
                                                —
                                            </div>
                                        </div>
                                        <div class="wkp-divider"></div>
                                        <div class="wkp-stat">
                                            <div class="wkp-stat-label">
                                                Last week
                                            </div>
                                            <div
                                                class="wkp-stat-val"
                                                id="wpLastWeek"
                                            >
                                                —
                                            </div>
                                            <div
                                                class="wkp-stat-sub"
                                                id="wpUnit"
                                            >
                                                TSS
                                            </div>
                                        </div>
                                        <div class="wkp-divider"></div>
                                        <div class="wkp-stat">
                                            <div class="wkp-stat-label">
                                                Fitness trend
                                            </div>
                                            <div
                                                class="wkp-ctl-delta"
                                                id="wpCTLDelta"
                                            >
                                                —
                                            </div>
                                            <div
                                                class="wkp-badge"
                                                id="wpTrendBadge"
                                            >
                                                —
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="wkp-badge wkp-mobile-badge"
                                    id="wpTrendBadgeMobile"
                                >
                                    —
                                </div>
                            </div>

                        </div>
                        <!-- /card-row week+status -->
                    </div>

                    <div data-dash-section="weeklyStats">
                        <div class="stat-grid-label">
                            This week <span id="statGridWeekRange"></span>
                        </div>
                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <div class="stat-label">Training Load</div>
                                    <div class="stat-icon green">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="stat-value" id="statTSS">—<span class="unit"> tss</span></div>
                                <div class="stat-delta neutral" id="statTSSDelta">Sync to load</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <div class="stat-label">Distance</div>
                                    <div class="stat-icon blue">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 12h18M3 6l9-3 9 3M3 18l9 3 9-3"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="stat-value" id="statDist">—<span class="unit"> km</span></div>
                                <div class="stat-delta neutral" id="statDistDelta">Sync to load</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <div class="stat-label">Ride Time</div>
                                    <div class="stat-icon orange">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <polyline points="12 6 12 12 16 14"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="stat-value" id="statTime">—<span class="unit"> h</span></div>
                                <div class="stat-delta neutral" id="statTimeDelta">Sync to load</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <div class="stat-label">Elevation</div>
                                    <div class="stat-icon purple">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="stat-value" id="statElev">—<span class="unit"> m</span></div>
                                <div class="stat-delta neutral" id="statElevDelta">Sync to load</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <div class="stat-label">Rides</div>
                                    <div class="stat-icon green">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="stat-value" id="statCount">—</div>
                                <div class="stat-delta neutral" id="statCountDelta">Sync to load</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <div class="stat-label">Avg Power</div>
                                    <div class="stat-icon orange">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="stat-value" id="statPower">—<span class="unit"> w</span></div>
                                <div class="stat-delta neutral" id="statPowerDelta">Sync to load</div>
                            </div>
                        </div>

                        <!-- Riding weather forecast (filled by renderWeatherForecast) -->
                        <div data-dash-section="weather">
                            <div class="card" id="forecastCard" style="display: none; margin-top: 16px"></div>
                        </div>
                    </div>

                    <!-- Training Load chart -->
                    <div data-dash-section="trainingLoad">
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Training Load</div>
                                </div>
                                <div class="card-header-controls">
                                    <span
                                        class="fitness-range-label"
                                        id="fitnessRangeLabel"
                                        >Last 30 days</span
                                    >
                                </div>
                            </div>
                            <div class="chart-wrap chart-wrap--fitness">
                                <canvas id="fitnessChart"></canvas>
                            </div>
                            <div class="fitness-legend-footer">
                                <div class="flf-item">
                                    <span
                                        class="flf-dot"
                                        style="background: var(--accent)"
                                    ></span>
                                    <div class="flf-text">
                                        <span class="flf-label"
                                            >CTL — Fitness</span
                                        >
                                        <span class="flf-desc"
                                            >Chronic Training Load. Your
                                            long-term fitness built over ~6
                                            weeks. Higher is fitter.</span
                                        >
                                    </div>
                                </div>
                                <div class="flf-item">
                                    <span
                                        class="flf-dot"
                                        style="background: var(--orange)"
                                    ></span>
                                    <div class="flf-text">
                                        <span class="flf-label"
                                            >ATL — Fatigue</span
                                        >
                                        <span class="flf-desc"
                                            >Acute Training Load. Recent
                                            training stress over ~1 week. Rises
                                            fast, drops fast.</span
                                        >
                                    </div>
                                </div>
                                <div class="flf-item">
                                    <span
                                        class="flf-dot"
                                        style="background: var(--blue)"
                                    ></span>
                                    <div class="flf-text">
                                        <span class="flf-label"
                                            >TSB — Form</span
                                        >
                                        <span class="flf-desc"
                                            >Training Stress Balance (CTL −
                                            ATL). Positive = fresh &amp; ready.
                                            Negative = fatigued.</span
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Average Power + Zone Distribution side by side -->
                    <div data-dash-section="powerZones">
                        <div class="card-row">
                            <div class="card" id="avgPowerCard">
                                <div class="card-header">
                                    <div>
                                        <div class="card-title">
                                            Average Power
                                        </div>
                                        <div class="card-subtitle">
                                            Per ride · 7-ride trend
                                        </div>
                                    </div>
                                    <div class="chart-legend">
                                        <span class="chart-legend-item"
                                            ><span
                                                class="chart-legend-dot"
                                                style="
                                                    background: var(--accent);
                                                "
                                            ></span
                                            >Trend</span
                                        >
                                    </div>
                                </div>
                                <div class="chart-wrap">
                                    <canvas id="avgPowerChart"></canvas>
                                </div>
                            </div>

                            <div
                                class="card"
                                id="zoneDistCard"
                                style="display: none"
                            >
                                <div class="card-header">
                                    <div>
                                        <div class="card-title">
                                            Zone Distribution
                                        </div>
                                        <div
                                            class="card-subtitle"
                                            id="zoneDistSubtitle"
                                        >
                                            Time in power zone
                                        </div>
                                    </div>
                                    <div
                                        class="zone-total-badge"
                                        id="zoneTotalBadge"
                                    ></div>
                                </div>
                                <div class="zone-list" id="zoneList"></div>
                                <div
                                    class="zone-balance-section"
                                    id="zoneBalanceSection"
                                    style="display: none"
                                ></div>
                            </div>
                        </div>
                    </div>

                    <!-- Power Curve -->
                    <div data-dash-section="powerCurve">
                        <div
                            class="card"
                            id="powerCurveCard"
                            style="display: none"
                        >
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Power Curve</div>
                                    <div
                                        class="card-subtitle"
                                        id="powerCurveSubtitle"
                                    >
                                        Best power efforts
                                    </div>
                                </div>
                            </div>
                            <div class="curve-peaks" id="curvePeaks"></div>
                            <div class="chart-wrap chart-wrap--lg">
                                <canvas id="powerCurveChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly TSS bar chart -->
                    <div data-dash-section="weeklyTss">
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Weekly Load</div>
                                    <div class="card-subtitle">
                                        TSS per week
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrap">
                                <canvas id="weeklyTssChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div data-dash-section="goalsTargets" id="goalsDashSection" style="display:none">
                        <div class="dash-section-header">
                            <div class="dash-section-title">Goals</div>
                            <a href="#" onclick="navigate('goals');return false" class="dash-section-link">View all</a>
                        </div>
                        <div class="goals-dash-scroll" id="goalsDashContent"></div>
                    </div>

                    <div data-dash-section="recentTable">
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        Recent Activities
                                    </div>
                                    <div
                                        class="card-subtitle"
                                        id="activitiesSubtitle"
                                    >
                                        Last 30 days
                                    </div>
                                </div>
                                <button
                                    class="btn btn-ghost"
                                    onclick="navigate('activities')"
                                >
                                    View all →
                                </button>
                            </div>
                            <div class="activity-list" id="activityList">
                                <div class="empty-state">
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="1.5"
                                    >
                                        <polyline
                                            points="22 12 18 12 15 21 9 3 6 12 2 12"
                                        />
                                    </svg>
                                    <p>
                                        No activities yet.<br />Connect your
                                        intervals.icu account and sync.
                                    </p>
                                    <button
                                        class="btn btn-primary"
                                        onclick="openModal()"
                                    >
                                        Connect intervals.icu
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== ACTIVITIES PAGE ==================== -->
                <div class="page" id="page-activities">
                        <div class="acts-toolbar">
                            <!-- Row 1: search + year + count -->
                            <div class="acts-toolbar-top">
                                <div class="acts-search-wrap">
                                    <svg
                                        class="acts-search-icon"
                                        viewBox="0 0 20 20"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="1.8"
                                    >
                                        <circle cx="8.5" cy="8.5" r="5.5" />
                                        <line x1="13" y1="13" x2="18" y2="18" />
                                    </svg>
                                    <input
                                        class="acts-search-input"
                                        id="activitiesSearch"
                                        type="text"
                                        placeholder="Search activities…"
                                        oninput="
                                            setActivitiesSearch(this.value)
                                        "
                                        autocomplete="off"
                                    />
                                    <kbd class="acts-search-kbd" id="searchKbd">S</kbd>
                                </div>
                                <select
                                    class="app-select app-select--sm"
                                    id="activitiesYearSelect"
                                    onchange="setActivitiesYear(this.value)"
                                >
                                    <option value="all">All years</option>
                                </select>
                                <span
                                    class="acts-count"
                                    id="allActivitiesSubtitle"
                                ></span>
                            </div>
                            <!-- Row 2: sport filter + sort -->
                            <div class="acts-filters-row">
                                <div class="acts-filter-group">
                                    <span class="sort-label">Type</span>
                                    <button
                                        class="sort-btn active"
                                        data-sport="all"
                                        onclick="setActivitiesSport('all')"
                                    >
                                        All
                                    </button>
                                    <button
                                        class="sort-btn"
                                        data-sport="outdoor"
                                        onclick="setActivitiesSport('outdoor')"
                                    >
                                        Outdoor
                                    </button>
                                    <button
                                        class="sort-btn"
                                        data-sport="indoor"
                                        onclick="setActivitiesSport('indoor')"
                                    >
                                        Indoor
                                    </button>
                                </div>
                                <div class="acts-toolbar-sep"></div>
                                <div class="acts-filter-group">
                                    <span class="sort-label">Sort</span>
                                    <button
                                        class="sort-btn active"
                                        data-sort="date"
                                        onclick="setActivitiesSort('date')"
                                    >
                                        Date<span class="sort-arrow"> ↓</span>
                                    </button>
                                    <button
                                        class="sort-btn"
                                        data-sort="distance"
                                        onclick="setActivitiesSort('distance')"
                                    >
                                        Distance<span class="sort-arrow"></span>
                                    </button>
                                    <button
                                        class="sort-btn"
                                        data-sort="time"
                                        onclick="setActivitiesSort('time')"
                                    >
                                        Time<span class="sort-arrow"></span>
                                    </button>
                                    <button
                                        class="sort-btn"
                                        data-sort="elevation"
                                        onclick="setActivitiesSort('elevation')"
                                    >
                                        Elevation<span
                                            class="sort-arrow"
                                        ></span>
                                    </button>
                                    <button
                                        class="sort-btn"
                                        data-sort="power"
                                        onclick="setActivitiesSort('power')"
                                    >
                                        Power<span class="sort-arrow"></span>
                                    </button>
                                    <button
                                        class="sort-btn"
                                        data-sort="bpm"
                                        onclick="setActivitiesSort('bpm')"
                                    >
                                        BPM<span class="sort-arrow"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="activity-list" id="allActivityList">
                            <div class="empty-state">
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="1.5"
                                >
                                    <polyline
                                        points="22 12 18 12 15 21 9 3 6 12 2 12"
                                    />
                                </svg>
                                <p>Sync data to view all activities.</p>
                            </div>
                        </div>
                </div>

                <!-- ==================== ACTIVITY DETAIL PAGE ==================== -->
                <div class="page" id="page-activity">
                    <!-- Activity hero -->
                    <div class="act-hero">
                        <div class="act-hero-identity">
                            <div class="act-hero-meta">
                                <div
                                    class="act-hero-date"
                                    id="detailDate"
                                ></div>
                                <h1 class="act-hero-title" id="detailName">
                                    —
                                </h1>
                                <div class="act-hero-eyebrow">
                                    <div
                                        class="activity-type-icon"
                                        id="detailIcon"
                                        style="display: none"
                                    ></div>
                                    <span
                                        class="act-type-badge"
                                        id="detailType"
                                    ></span>
                                    <span
                                        class="act-platform-tag"
                                        id="detailPlatformTag"
                                        style="display: none"
                                    ></span>
                                    <div
                                        class="act-tss-badge"
                                        id="detailTSSBadge"
                                        style="display: none"
                                    ></div>
                                </div>
                            </div>
                        </div>
                        <!-- 4 primary stats -->
                        <div class="card act-primary-card">
                            <div
                                class="act-primary-stats"
                                id="actPrimaryStats"
                            ></div>
                        </div>
                    </div>

                    <!-- Secondary stats strip -->
                    <div
                        class="act-secondary-strip"
                        id="actSecondaryStats"
                    ></div>

                    <!-- vs-average comparison card -->
                    <div
                        class="card"
                        id="detailCompareCard"
                        style="display: none"
                    >
                        <div class="card-header">
                            <div>
                                <div class="card-title">How You Compare</div>
                                <div
                                    class="card-subtitle"
                                    id="detailCompareSubtitle"
                                ></div>
                            </div>
                            <span
                                class="detail-cmp-badge"
                                id="detailCmpBadge"
                            ></span>
                        </div>
                        <div class="detail-cmp-rows" id="detailCmpRows"></div>
                    </div>

                    <!-- Route map -->
                    <div class="card" id="detailMapCard" style="display: none">
                        <button
                            class="map-close-btn"
                            id="mapCloseBtn"
                            onclick="toggleMapFullscreen()"
                            title="Close fullscreen"
                        >
                            <svg
                                viewBox="0 0 24 24"
                                width="20"
                                height="20"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <line x1="18" y1="6" x2="6" y2="18" />
                                <line x1="6" y1="6" x2="18" y2="18" />
                            </svg>
                        </button>
                        <div class="card-header">
                            <div class="card-title">Route</div>
                            <button
                                class="map-expand-btn btn btn-ghost btn-sm"
                                onclick="toggleMapFullscreen()"
                                id="mapExpandBtn"
                                title="Expand map"
                            >
                                <svg
                                    viewBox="0 0 24 24"
                                    width="16"
                                    height="16"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <polyline points="15 3 21 3 21 9" />
                                    <polyline points="9 21 3 21 3 15" />
                                    <line x1="21" y1="3" x2="14" y2="10" />
                                    <line x1="3" y1="21" x2="10" y2="14" />
                                </svg>
                            </button>
                        </div>
                        <div
                            id="mapColorToggles"
                            class="map-color-toggles"
                        ></div>

                        <!-- Flythrough controls — shown once GPS data is available -->
                        <div
                            id="flythroughBar"
                            class="flythrough-bar"
                            style="display: none"
                        >
                            <button
                                class="ft-play-btn"
                                id="ftPlayBtn"
                                onclick="ftTogglePlay()"
                                title="Play flythrough"
                            >
                                <svg
                                    width="11"
                                    height="13"
                                    viewBox="0 0 11 13"
                                    fill="currentColor"
                                >
                                    <polygon points="0,0 11,6.5 0,13" />
                                </svg>
                            </button>
                            <div class="ft-scrubber-track" id="ftScrubberTrack">
                                <div
                                    class="ft-scrubber-fill"
                                    id="ftScrubberFill"
                                ></div>
                                <div
                                    class="ft-scrubber-thumb"
                                    id="ftScrubberThumb"
                                ></div>
                            </div>
                            <select
                                class="app-select app-select--sm"
                                id="ftSpeedSelect"
                                onchange="ftSetSpeed(this.value)"
                            >
                                <option value="1">Realtime</option>
                                <option value="5">5×</option>
                                <option value="15">15×</option>
                                <option value="30" selected>30×</option>
                                <option value="60">60×</option>
                            </select>
                            <button
                                class="ft-follow-btn active"
                                id="ftFollowBtn"
                                onclick="ftToggleFollow()"
                                title="Follow dot on map"
                            >
                                <svg
                                    width="13"
                                    height="13"
                                    viewBox="0 0 18 18"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="1.8"
                                    stroke-linecap="round"
                                >
                                    <circle cx="9" cy="9" r="3" />
                                    <line x1="9" y1="1" x2="9" y2="5" />
                                    <line x1="9" y1="13" x2="9" y2="17" />
                                    <line x1="1" y1="9" x2="5" y2="9" />
                                    <line x1="13" y1="9" x2="17" y2="9" />
                                </svg>
                            </button>
                        </div>

                        <div class="map-with-stats">
                            <div id="activityMap" class="activity-map"></div>
                            <div id="mapStatsPanel" class="map-stats-panel">
                                <p class="map-stat-hint">
                                    Hover the<br />route to<br />see stats
                                </p>
                            </div>
                        </div>
                        <!-- Fullscreen bottom row: stats left, chart right -->
                        <div class="fs-bottom-row" id="fsBottomRow">
                            <div class="fs-bottom-left" id="fsBottomLeft"></div>
                            <div class="fs-bottom-right" id="fsMiniChart">
                                <div class="fs-mini-chart-header">
                                    <div
                                        class="fs-mini-toggles"
                                        id="fsMiniToggles"
                                    ></div>
                                </div>
                                <canvas
                                    id="fsMiniCanvas"
                                    width="360"
                                    height="100"
                                ></canvas>
                                <div class="fs-mini-vals" id="fsMiniVals"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Combined activity streams chart -->
                    <div
                        class="card"
                        id="detailStreamsCard"
                        style="display: none"
                    >
                        <div class="card-header">
                            <div>
                                <div class="card-title">Activity Data</div>
                                <div
                                    class="card-subtitle"
                                    id="detailStreamsSubtitle"
                                ></div>
                            </div>
                            <div class="streams-zoom-controls">
                                <button
                                    class="streams-zoom-btn"
                                    onclick="streamsZoomIn()"
                                    title="Zoom in"
                                >
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2.5"
                                    >
                                        <circle cx="11" cy="11" r="8" />
                                        <line
                                            x1="21"
                                            y1="21"
                                            x2="16.65"
                                            y2="16.65"
                                        />
                                        <line x1="11" y1="8" x2="11" y2="14" />
                                        <line x1="8" y1="11" x2="14" y2="11" />
                                    </svg>
                                </button>
                                <button
                                    class="streams-zoom-btn"
                                    onclick="streamsZoomOut()"
                                    title="Zoom out"
                                >
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2.5"
                                    >
                                        <circle cx="11" cy="11" r="8" />
                                        <line
                                            x1="21"
                                            y1="21"
                                            x2="16.65"
                                            y2="16.65"
                                        />
                                        <line x1="8" y1="11" x2="14" y2="11" />
                                    </svg>
                                </button>
                                <button
                                    class="streams-zoom-btn streams-zoom-btn--reset"
                                    onclick="streamsResetZoom()"
                                    title="Reset zoom"
                                >
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2.5"
                                    >
                                        <path
                                            d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
                                        />
                                        <path d="M3 3v5h5" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="chart-wrap" style="height: 280px">
                            <canvas id="activityStreamsChart"></canvas>
                        </div>
                        <div class="streams-footer">
                            <div
                                class="stream-toggles"
                                id="streamToggleChips"
                            ></div>
                            <div class="streams-zoom-hint" id="streamsZoomHint">
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    width="12"
                                    height="12"
                                >
                                    <circle cx="11" cy="11" r="8" />
                                    <line
                                        x1="21"
                                        y1="21"
                                        x2="16.65"
                                        y2="16.65"
                                    />
                                    <line x1="11" y1="8" x2="11" y2="14" />
                                    <line x1="8" y1="11" x2="14" y2="11" />
                                </svg>
                                Alt + Scroll to zoom · Drag to pan
                            </div>
                        </div>
                    </div>

                    <!-- Loading skeletons -->
                    <div
                        class="detail-charts-loading"
                        id="detailChartsLoading"
                        style="display: none"
                    >
                        <div class="skeleton-card">
                            <div
                                class="skeleton"
                                style="
                                    width: 35%;
                                    height: 14px;
                                    margin-bottom: 16px;
                                    border-radius: 4px;
                                "
                            ></div>
                            <div
                                class="skeleton"
                                style="
                                    width: 100%;
                                    height: 180px;
                                    border-radius: 8px;
                                "
                            ></div>
                        </div>
                        <div class="skeleton-card">
                            <div
                                class="skeleton"
                                style="
                                    width: 28%;
                                    height: 14px;
                                    margin-bottom: 16px;
                                    border-radius: 4px;
                                "
                            ></div>
                            <div
                                class="skeleton"
                                style="
                                    width: 100%;
                                    height: 180px;
                                    border-radius: 8px;
                                "
                            ></div>
                        </div>
                    </div>

                    <!-- Power + HR stream charts (only if streams available) -->
                    <div
                        class="detail-charts-row"
                        id="detailChartsRow"
                        style="display: none"
                    >
                        <div
                            class="card"
                            id="detailPowerCard"
                            style="display: none"
                        >
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Power</div>
                                    <div
                                        class="card-subtitle"
                                        id="detailPowerSubtitle"
                                    ></div>
                                </div>
                            </div>
                            <div class="chart-wrap" style="height: 200px">
                                <canvas id="activityPowerChart"></canvas>
                            </div>
                        </div>
                        <div
                            class="card"
                            id="detailHRCard"
                            style="display: none"
                        >
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Heart Rate</div>
                                    <div
                                        class="card-subtitle"
                                        id="detailHRSubtitle"
                                    ></div>
                                </div>
                            </div>
                            <div class="chart-wrap" style="height: 200px">
                                <canvas id="activityHRChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Performance analysis metrics -->
                    <div class="card" id="detailPerfCard" style="display: none">
                        <div class="card-header">
                            <div>
                                <div class="card-title">
                                    Performance Analysis
                                </div>
                                <div
                                    class="card-subtitle"
                                    id="detailPerfSubtitle"
                                ></div>
                            </div>
                        </div>
                        <div
                            class="perf-metrics-grid"
                            id="detailPerfGrid"
                        ></div>
                    </div>

                    <!-- Aerobic Decoupling chart -->
                    <div
                        class="card"
                        id="detailDecoupleCard"
                        style="display: none"
                    >
                        <div class="card-header">
                            <div>
                                <div class="card-title">Aerobic Decoupling</div>
                                <div
                                    class="card-subtitle"
                                    id="detailDecoupleSub"
                                >
                                    Efficiency Factor over time · power ÷ HR
                                </div>
                            </div>
                            <span
                                class="detail-decouple-badge"
                                id="detailDecoupleBadge"
                            ></span>
                        </div>
                        <div class="detail-decouple-wrap">
                            <div class="chart-wrap" style="height: 180px">
                                <canvas id="detailDecoupleChart"></canvas>
                            </div>
                            <div
                                class="detail-decouple-halves"
                                id="detailDecoupleHalves"
                            ></div>
                        </div>
                    </div>

                    <!-- Power zones + HR zones side by side -->
                    <div class="detail-zones-row">
                        <div
                            class="card"
                            id="detailZonesCard"
                            style="display: none"
                        >
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Power Zones</div>
                                    <div
                                        class="card-subtitle"
                                        id="detailZonesSubtitle"
                                    ></div>
                                </div>
                                <span
                                    class="zone-total-badge"
                                    id="detailZonesTotalBadge"
                                ></span>
                            </div>
                            <div id="detailZoneList"></div>
                        </div>

                        <div
                            class="card"
                            id="detailHRZonesCard"
                            style="display: none"
                        >
                            <div class="card-header">
                                <div>
                                    <div class="card-title">HR Zones</div>
                                    <div
                                        class="card-subtitle"
                                        id="detailHRZonesSubtitle"
                                    ></div>
                                </div>
                                <span
                                    class="zone-total-badge"
                                    id="detailHRZonesTotalBadge"
                                ></span>
                            </div>
                            <div id="detailHRZoneList"></div>
                        </div>
                    </div>

                    <!-- Ride power curve + HR curve — side by side on desktop -->
                    <div class="detail-curves-row" id="detailCurvesRow">
                        <div
                            class="card"
                            id="detailCurveCard"
                            style="display: none"
                        >
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        Ride Power Curve
                                    </div>
                                    <div
                                        class="card-subtitle"
                                        id="detailCurveSubtitle"
                                    >
                                        Best efforts this ride
                                    </div>
                                </div>
                                <div
                                    class="curve-legend"
                                    id="detailCurveLegend"
                                ></div>
                            </div>
                            <div
                                class="curve-peaks"
                                id="detailCurvePeaks"
                            ></div>
                            <div class="chart-wrap" style="height: 220px">
                                <canvas id="activityCurveChart"></canvas>
                            </div>
                        </div>

                        <div
                            class="card"
                            id="detailHRCurveCard"
                            style="display: none"
                        >
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        Heart Rate Curve
                                    </div>
                                    <div class="card-subtitle">
                                        Best avg HR over duration · this ride
                                    </div>
                                </div>
                                <div
                                    class="curve-legend"
                                    id="detailHRCurveLegend"
                                ></div>
                            </div>
                            <div
                                class="curve-peaks"
                                id="detailHRCurvePeaks"
                            ></div>
                            <div class="chart-wrap" style="height: 220px">
                                <canvas id="activityHRCurveChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Gradient / Elevation Profile -->
                    <div
                        class="card"
                        id="detailGradientCard"
                        style="display: none"
                    >
                        <div class="card-header">
                            <div>
                                <div class="card-title">Elevation Profile</div>
                                <div
                                    class="card-subtitle"
                                    id="detailGradientSubtitle"
                                >
                                    Altitude · gradient colour-coded by
                                    steepness
                                </div>
                            </div>
                        </div>
                        <div class="chart-wrap" style="height: 160px">
                            <canvas id="detailGradientChart"></canvas>
                        </div>
                    </div>

                    <!-- Cadence Distribution -->
                    <div
                        class="card"
                        id="detailCadenceCard"
                        style="display: none"
                    >
                        <div class="card-header">
                            <div>
                                <div class="card-title">
                                    Cadence Distribution
                                </div>
                                <div
                                    class="card-subtitle"
                                    id="detailCadenceSubtitle"
                                >
                                    Time spent at each cadence range
                                </div>
                            </div>
                        </div>
                        <div class="chart-wrap" style="height: 180px">
                            <canvas id="detailCadenceChart"></canvas>
                        </div>
                    </div>

                    <!-- Power histogram (only if histogram data in API response) -->
                    <div
                        class="card"
                        id="detailHistogramCard"
                        style="display: none"
                    >
                        <div class="card-header">
                            <div>
                                <div class="card-title">Power Distribution</div>
                                <div class="card-subtitle">
                                    Time at each watt level
                                </div>
                            </div>
                        </div>
                        <div class="chart-wrap" style="height: 200px">
                            <canvas id="activityHistogramChart"></canvas>
                        </div>
                    </div>

                    <!-- Ambient temperature graph (Garmin sensor) -->
                    <div class="card" id="detailTempCard">
                        <div class="card-header">
                            <div>
                                <div class="card-title">
                                    Outside Temperature
                                </div>
                                <div
                                    class="card-subtitle"
                                    id="detailTempSubtitle"
                                >
                                    Recorded by Garmin sensor
                                </div>
                            </div>
                        </div>
                        <div class="detail-temp-wrap">
                            <div class="chart-wrap" style="height: 180px">
                                <canvas id="activityTempChart"></canvas>
                            </div>
                            <div
                                class="detail-temp-unavailable"
                                id="detailTempUnavailable"
                                style="display: none"
                            >
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="1.5"
                                    width="28"
                                    height="28"
                                >
                                    <path
                                        d="M12 2v10m0 0a3 3 0 1 0 0 6 3 3 0 0 0 0-6zm0 0V2"
                                    />
                                    <path d="M9 9h.01M15 9h.01" />
                                </svg>
                                <span
                                    >Temperature data not available for this
                                    activity</span
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Weather conditions during this ride -->
                    <div
                        class="card"
                        id="detailWeatherCard"
                        style="display: none"
                    >
                        <div class="card-header">
                            <div class="card-title">Ride Conditions</div>
                        </div>
                        <div class="wx-tiles" id="wxTiles"></div>
                    </div>

                    <!-- Export options -->
                    <div class="card" id="detailExportCard">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Export Activity</div>
                                <div class="card-subtitle">
                                    Download in your preferred format
                                </div>
                            </div>
                        </div>
                        <div
                            class="detail-export-buttons"
                            id="detailExportButtons"
                        ></div>
                    </div>

                    <!-- Data source footer -->
                    <div
                        class="detail-source-footer"
                        id="detailSourceFooter"
                    ></div>
                </div>

                <!-- ==================== CALENDAR PAGE ==================== -->
                <div class="page" id="page-calendar">
                    <div class="cal-shell">
                        <div class="cal-header">
                            <div class="cal-header-nav">
                                <button class="btn btn-ghost btn-icon" onclick="calPrevMonth()" title="Previous month">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                                </button>
                                <button class="btn btn-ghost btn-icon" onclick="calNextMonth()" title="Next month">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                                </button>
                                <button class="cal-today-btn" onclick="calGoToday()">Today</button>
                            </div>
                            <button class="btn btn-ghost btn-icon cal-panel-toggle" id="calPanelToggle" onclick="toggleCalPanel()" title="Toggle sidebar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
                            </button>
                        </div>
                        <div class="cal-stats-strip">
                            <div class="cal-hstat">
                                <span class="cal-hstat-val" id="calStatActivities">—</span>
                                <span class="cal-hstat-label">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                    Activities
                                </span>
                            </div>
                            <div class="cal-hstat-div"></div>
                            <div class="cal-hstat">
                                <span class="cal-hstat-val" id="calStatDist">—</span>
                                <span class="cal-hstat-label">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><polyline points="8 7 3 12 8 17"/><polyline points="16 7 21 12 16 17"/></svg>
                                    Distance
                                </span>
                            </div>
                            <div class="cal-hstat-div"></div>
                            <div class="cal-hstat">
                                <span class="cal-hstat-val" id="calStatTime">—</span>
                                <span class="cal-hstat-label">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    Time
                                </span>
                            </div>
                            <div class="cal-hstat-div"></div>
                            <div class="cal-hstat">
                                <span class="cal-hstat-val" id="calStatTSS">—</span>
                                <span class="cal-hstat-label">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                                    Load
                                </span>
                            </div>
                            <div class="cal-hstat-div"></div>
                            <div class="cal-hstat">
                                <span class="cal-hstat-val" id="calStatCals">—</span>
                                <span class="cal-hstat-label">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2c0 6-6 8-6 13a6 6 0 0 0 12 0c0-5-6-7-6-13z"/><path d="M12 12c0 3-2 4-2 6a2 2 0 0 0 4 0c0-2-2-3-2-6z"/></svg>
                                    Calories
                                </span>
                            </div>
                        </div>
                        <div class="cal-body">
                            <div class="cal-left">
                                <div class="cal-dow-row">
                                    <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div>
                                    <div class="cal-dow--weekend">Sat</div><div class="cal-dow--weekend">Sun</div>
                                </div>
                                <div class="cal-grid" id="calGrid"></div>
                            </div>
                            <div class="cal-day-panel" id="calDayPanel">
                                <div class="cal-day-panel-header" id="calDayPanelHeader">Select a day</div>
                                <div class="cal-day-panel-list" id="calDayPanelList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="page" id="page-fitness">
                    <!-- ── Key metrics row ── -->
                    <div class="fit-kpi-row">
                        <div class="fit-kpi-card">
                            <div class="fit-kpi-label">CTL</div>
                            <div
                                class="fit-kpi-value fit-kpi-value--ctl"
                                id="fitCTL"
                            >
                                —
                            </div>
                            <div class="fit-kpi-name">Fitness</div>
                            <div class="fit-kpi-bar">
                                <div
                                    class="fit-kpi-bar-fill fit-kpi-bar-fill--ctl"
                                    id="fitBarCTL"
                                ></div>
                            </div>
                        </div>
                        <div class="fit-kpi-card">
                            <div class="fit-kpi-label">ATL</div>
                            <div
                                class="fit-kpi-value fit-kpi-value--atl"
                                id="fitATL"
                            >
                                —
                            </div>
                            <div class="fit-kpi-name">Fatigue</div>
                            <div class="fit-kpi-bar">
                                <div
                                    class="fit-kpi-bar-fill fit-kpi-bar-fill--atl"
                                    id="fitBarATL"
                                ></div>
                            </div>
                        </div>
                        <div class="fit-kpi-card">
                            <div class="fit-kpi-label">TSB</div>
                            <div class="fit-kpi-value" id="fitTSB">—</div>
                            <div class="fit-kpi-name">Form</div>
                            <div class="fit-kpi-bar">
                                <div
                                    class="fit-kpi-bar-fill"
                                    id="fitBarTSB"
                                ></div>
                            </div>
                        </div>
                        <div class="fit-kpi-card">
                            <div class="fit-kpi-label">Ramp Rate</div>
                            <div class="fit-kpi-value" id="fitRamp">—</div>
                            <div class="fit-kpi-name">CTL / week</div>
                            <div class="fit-kpi-hint" id="fitRampHint"></div>
                        </div>
                        <div class="fit-kpi-card">
                            <div class="fit-kpi-label">Streak</div>
                            <div
                                class="fit-kpi-value fit-kpi-value--streak"
                                id="fitStreak"
                            >
                                —
                            </div>
                            <div class="fit-kpi-name">days</div>
                            <div class="fit-kpi-hint" id="fitStreakHint"></div>
                        </div>
                        <div class="fit-kpi-card">
                            <div class="fit-kpi-label">This Week</div>
                            <div class="fit-kpi-value" id="fitWeekActs">—</div>
                            <div class="fit-kpi-name">activities</div>
                            <div class="fit-kpi-hint" id="fitWeekHint"></div>
                        </div>
                    </div>

                    <!-- ── Wellness strip (shown only if data available) ── -->
                    <div
                        class="fit-wellness-strip"
                        id="fitWellnessStrip"
                        style="display: none"
                    >
                        <div
                            class="fit-wcard"
                            id="fitWcardHRV"
                            style="display: none"
                        >
                            <div class="fit-wcard-label">
                                HRV
                                <span
                                    class="fit-wcard-trend"
                                    id="fitHRVTrend"
                                ></span>
                            </div>
                            <div class="fit-wcard-val" id="fitHRV">—</div>
                            <div class="fit-wcard-sub">ms · 7-day avg</div>
                        </div>
                        <div
                            class="fit-wcard"
                            id="fitWcardHR"
                            style="display: none"
                        >
                            <div class="fit-wcard-label">Resting HR</div>
                            <div class="fit-wcard-val" id="fitRestHR">—</div>
                            <div class="fit-wcard-sub">bpm · latest</div>
                        </div>
                        <div
                            class="fit-wcard"
                            id="fitWcardSleep"
                            style="display: none"
                        >
                            <div class="fit-wcard-label">
                                Sleep
                                <span
                                    class="fit-wcard-trend"
                                    id="fitSleepTrend"
                                ></span>
                            </div>
                            <div class="fit-wcard-val" id="fitSleep">—</div>
                            <div class="fit-wcard-sub">hours · 7-day avg</div>
                        </div>
                        <div
                            class="fit-wcard"
                            id="fitWcardWeight"
                            style="display: none"
                        >
                            <div class="fit-wcard-label">
                                Weight
                                <span
                                    class="fit-wcard-trend"
                                    id="fitWeightTrend"
                                ></span>
                            </div>
                            <div class="fit-wcard-val" id="fitWeight">—</div>
                            <div class="fit-wcard-sub">kg · latest</div>
                        </div>
                    </div>

                    <!-- ── Training Load History chart ── -->
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">
                                    Training Load History
                                </div>
                                <div class="card-subtitle">
                                    Chronic (CTL) · Acute (ATL) · Form (TSB)
                                </div>
                            </div>
                            <div class="card-header-controls">
                                <div class="chart-legend">
                                    <span class="chart-legend-item"
                                        ><span
                                            class="chart-legend-dot"
                                            style="background: var(--accent)"
                                        ></span
                                        >CTL</span
                                    >
                                    <span class="chart-legend-item"
                                        ><span
                                            class="chart-legend-dot"
                                            style="background: var(--orange)"
                                        ></span
                                        >ATL</span
                                    >
                                    <span class="chart-legend-item"
                                        ><span
                                            class="chart-legend-dot"
                                            style="background: var(--blue)"
                                        ></span
                                        >TSB</span
                                    >
                                </div>
                                <div class="fit-range-pills" id="fitRangePills">
                                    <button
                                        id="fitRange30"
                                        onclick="setFitnessRange(30)"
                                    >
                                        30d
                                    </button>
                                    <button
                                        id="fitRange90"
                                        onclick="setFitnessRange(90)"
                                        class="active"
                                    >
                                        90d
                                    </button>
                                    <button
                                        id="fitRange180"
                                        onclick="setFitnessRange(180)"
                                    >
                                        6m
                                    </button>
                                    <button
                                        id="fitRange365"
                                        onclick="setFitnessRange(365)"
                                    >
                                        1y
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="chart-wrap chart-wrap--lg">
                            <canvas id="fitnessPageChart"></canvas>
                        </div>
                    </div>

                    <!-- ── Training Calendar + Weekly Load (side by side, equal height) ── -->
                    <div class="fit-cal-row">
                        <!-- Training Calendar heatmap -->
                        <div class="card fit-card-flex">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        Training Calendar
                                    </div>
                                    <div class="card-subtitle">
                                        Last 26 weeks · intensity = training
                                        load
                                    </div>
                                </div>
                                <div class="fit-hm-legend">
                                    <span>Less</span>
                                    <span
                                        class="fit-hm-swatch fit-hm-swatch--0"
                                    ></span>
                                    <span
                                        class="fit-hm-swatch fit-hm-swatch--1"
                                    ></span>
                                    <span
                                        class="fit-hm-swatch fit-hm-swatch--2"
                                    ></span>
                                    <span
                                        class="fit-hm-swatch fit-hm-swatch--3"
                                    ></span>
                                    <span
                                        class="fit-hm-swatch fit-hm-swatch--4"
                                    ></span>
                                    <span>More</span>
                                </div>
                            </div>
                            <div class="fit-heatmap-scroll fit-heatmap-fill">
                                <div class="fit-heatmap" id="fitHeatmap"></div>
                            </div>
                        </div>

                        <!-- Weekly Load bars -->
                        <div class="card fit-card-flex">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Weekly Load</div>
                                    <div class="card-subtitle">
                                        TSS per week · last 16 weeks
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrap fit-chart-fill">
                                <canvas id="fitnessWeeklyPageChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- ── Monthly Summary (full width) ── -->
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Monthly Summary</div>
                                <div class="card-subtitle">
                                    Rolling 6 months
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Summary table -->
                        <div class="fit-monthly-wrap">
                            <table class="fit-monthly-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Rides</th>
                                        <th>Distance</th>
                                        <th>Time</th>
                                        <th>TSS</th>
                                    </tr>
                                </thead>
                                <tbody id="fitMonthlyBody">
                                    <tr>
                                        <td
                                            colspan="5"
                                            style="
                                                text-align: center;
                                                color: var(--text-muted);
                                                padding: 24px;
                                            "
                                        >
                                            Sync to load
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- ── Best Distance Efforts ── -->
                    <div class="card" id="fitBestEffortsCard">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Best Distance Efforts</div>
                                <div class="card-subtitle">Fastest estimated time per distance · all rides</div>
                            </div>
                        </div>
                        <div class="fit-be-grid" id="fitBestEffortsGrid"></div>
                    </div>
                    <!-- ── Zone Distribution (Fitness page) ── -->
                    <div class="card" id="fitZoneCard" style="display: none">
                        <div class="card-header">
                            <div>
                                <div class="card-title">
                                    Power Zone Distribution
                                </div>
                                <div class="card-subtitle" id="fitZoneSubtitle">
                                    Time in zone · all activities
                                </div>
                            </div>
                            <div class="fit-zone-tabs">
                                <button
                                    class="fit-zone-tab active"
                                    onclick="setFitZoneRange(90)"
                                    id="fitZoneTab90"
                                >
                                    90d
                                </button>
                                <button
                                    class="fit-zone-tab"
                                    onclick="setFitZoneRange(365)"
                                    id="fitZoneTab365"
                                >
                                    1y
                                </button>
                                <button
                                    class="fit-zone-tab"
                                    onclick="setFitZoneRange(0)"
                                    id="fitZoneTabAll"
                                >
                                    All
                                </button>
                            </div>
                        </div>

                        <!-- KPI strip -->
                        <div class="fit-zone-kpis" id="fitZoneKpis"></div>

                        <!-- Chart + zone rows side by side -->
                        <div class="fit-zone-body">
                            <div class="fit-zone-chart-wrap">
                                <canvas id="fitZonePie"></canvas>
                                <div
                                    class="fit-zone-pie-center"
                                    id="fitZonePieCenter"
                                ></div>
                            </div>
                            <div class="fit-zone-rows" id="fitZoneRows"></div>
                        </div>

                        <!-- Stacked balance bar + style -->
                        <div class="fit-zone-balance" id="fitZoneBalance"></div>
                    </div>
                </div>
                <!-- /page-fitness -->

                <div class="page" id="page-power">
                    <!-- ── Hero stat row ── -->
                    <div class="pwr-hero-row" id="pwrHeroRow"></div>

                    <!-- ── Power Curve Chart ── -->
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Power Curve</div>
                                <div
                                    class="card-subtitle"
                                    id="pwrCurveSubtitle"
                                >
                                    Best efforts over selected period
                                </div>
                            </div>
                            <div class="card-header-controls">
                                <div class="fit-range-pills" id="pwrRangePills">
                                    <button
                                        data-days="30"
                                        onclick="setPwrRange(30)"
                                    >
                                        30d
                                    </button>
                                    <button
                                        data-days="90"
                                        onclick="setPwrRange(90)"
                                        class="active"
                                    >
                                        90d
                                    </button>
                                    <button
                                        data-days="180"
                                        onclick="setPwrRange(180)"
                                    >
                                        6mo
                                    </button>
                                    <button
                                        data-days="365"
                                        onclick="setPwrRange(365)"
                                    >
                                        1yr
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="curve-peaks" id="pwrCurvePeaks"></div>
                        <div
                            class="chart-wrap--lg"
                            style="position: relative; margin-top: 12px"
                        >
                            <canvas id="pwrCurveCanvas"></canvas>
                        </div>
                    </div>

                    <!-- ── Power Zones ── -->
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Power Zones</div>
                                <div class="card-subtitle" id="pwrZoneSubtitle">
                                    Coggan 6-zone model · based on FTP
                                </div>
                            </div>
                            <div class="pwr-ftp-badge" id="pwrFtpBadge"></div>
                        </div>
                        <div id="pwrZoneRows"></div>
                    </div>

                    <!-- ── Zone Distribution + Recent Power Trend ── -->
                    <div class="card-row">
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        Zone Distribution
                                    </div>
                                    <div
                                        class="card-subtitle"
                                        id="pwrZoneDistSub"
                                    >
                                        Time in power zone
                                    </div>
                                </div>
                                <div
                                    class="zone-total-badge"
                                    id="pwrZoneTotalBadge"
                                ></div>
                            </div>
                            <div class="zone-list" id="pwrZoneList"></div>
                            <div
                                class="zone-balance-section"
                                id="pwrZoneBalance"
                                style="display: none"
                            ></div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Power Trend</div>
                                    <div class="card-subtitle">
                                        Normalized power per ride
                                    </div>
                                </div>
                            </div>
                            <div
                                class="chart-wrap--md"
                                style="position: relative"
                            >
                                <canvas id="pwrTrendCanvas"></canvas>
                            </div>
                            <div id="pwrTrendSummary"></div>
                        </div>
                    </div>

                    <!-- ── Insights / Encouragement ── -->
                    <div class="pwr-insights-row" id="pwrInsightsRow"></div>
                </div>

                <div class="page" id="page-zones">
                    <!-- ── KPI hero strip ── -->
                    <div class="znp-kpi-row" id="znpKpiRow"></div>

                    <!-- ── Zone distributions: HR + Power side by side ── -->
                    <div class="znp-zones-row">
                        <div class="card" id="znpHRZoneCard">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        Heart Rate Zones
                                    </div>
                                    <div
                                        class="card-subtitle"
                                        id="znpHRZoneSub"
                                    >
                                        Time in HR zone
                                    </div>
                                </div>
                                <span
                                    class="znp-total-badge"
                                    id="znpHRZoneBadge"
                                ></span>
                            </div>
                            <div id="znpHRZoneBody"></div>
                            <div id="znpHRZoneBalance"></div>
                        </div>
                        <div class="card" id="znpPwrZoneCard">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Power Zones</div>
                                    <div
                                        class="card-subtitle"
                                        id="znpPwrZoneSub"
                                    >
                                        Time in power zone
                                    </div>
                                </div>
                                <span
                                    class="znp-total-badge"
                                    id="znpPwrZoneBadge"
                                ></span>
                            </div>
                            <div id="znpPwrZoneBody"></div>
                            <div id="znpPwrZoneBalance"></div>
                        </div>
                    </div>

                    <!-- ── Aerobic Decoupling trend ── -->
                    <div class="card" id="znpDecoupleCard">
                        <div class="card-header">
                            <div>
                                <div class="card-title">
                                    Aerobic Decoupling Trend
                                </div>
                                <div class="card-subtitle" id="znpDecoupleSub">
                                    HR drift vs power · per ride
                                </div>
                            </div>
                            <span
                                class="znp-total-badge"
                                id="znpDecoupleAvgBadge"
                            ></span>
                        </div>
                        <div class="chart-wrap" style="height: 200px">
                            <canvas id="znpDecoupleChart"></canvas>
                        </div>
                        <div class="znp-decouple-legend">
                            <span
                                class="znp-decouple-zone znp-decouple-zone--good"
                                >Under 5% — Aerobically fit</span
                            >
                            <span
                                class="znp-decouple-zone znp-decouple-zone--fair"
                                >5–8% — Acceptable</span
                            >
                            <span
                                class="znp-decouple-zone znp-decouple-zone--poor"
                                >Over 8% — Needs work</span
                            >
                        </div>
                    </div>

                    <!-- Zone Distribution Over Time -->
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">
                                    Zone Distribution Over Time
                                </div>
                                <div class="card-subtitle" id="znpZoneTimeSub">
                                    Weekly power zone breakdown
                                </div>
                            </div>
                        </div>
                        <div class="chart-wrap" style="height: 220px">
                            <canvas id="znpZoneTimeChart"></canvas>
                        </div>
                    </div>

                    <!-- ── Training insights ── -->
                    <div id="znpInsightsRow" class="znp-insights-row"></div>
                </div>

                <!-- (Streaks page merged into Goals) -->

                <!-- ==================== WORKOUT BUILDER ==================== -->
                <div class="page" id="page-workout">
                    <!-- Top bar: name + stats -->
                    <div class="wrk-topbar">
                        <input
                            class="wrk-name-input"
                            id="wrkNameInput"
                            placeholder="Workout name"
                            value="New Workout"
                            oninput="
                                wrkState.name = this.value;
                                wrkRefreshStats();
                            "
                        />
                        <div class="wrk-topbar-stats">
                            <span class="wrk-stat"
                                ><span class="wrk-stat-val" id="wrkTotalTime"
                                    >0:00</span
                                ><span class="wrk-stat-lbl"
                                    >duration</span
                                ></span
                            >
                            <span class="wrk-stat-sep">·</span>
                            <span class="wrk-stat"
                                ><span class="wrk-stat-val" id="wrkTotalTSS"
                                    >0</span
                                ><span class="wrk-stat-lbl">TSS</span></span
                            >
                            <span class="wrk-stat-sep">·</span>
                            <span class="wrk-stat"
                                ><span class="wrk-stat-val" id="wrkFtpDisp"
                                    >—</span
                                ><span class="wrk-stat-lbl">FTP w</span></span
                            >
                        </div>
                        <button
                            class="btn btn-ghost wrk-clear-btn"
                            onclick="wrkClear()"
                        >
                            New
                        </button>
                    </div>

                    <!-- Visual chart -->
                    <div class="card wrk-chart-card">
                        <canvas id="wrkCanvas" class="wrk-canvas"></canvas>
                        <div class="wrk-chart-empty" id="wrkChartEmpty">
                            Add segments below to preview your workout
                        </div>
                    </div>

                    <!-- Segment list -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Segments</div>
                            <div class="wrk-ftp-row">
                                <label class="wrk-ftp-label"
                                    >FTP override</label
                                >
                                <input
                                    class="wrk-ftp-input"
                                    id="wrkFtpInput"
                                    type="number"
                                    min="50"
                                    max="600"
                                    placeholder="auto"
                                    oninput="wrkSetFtp(this.value)"
                                />
                                <span class="wrk-ftp-unit">w</span>
                            </div>
                        </div>
                        <div class="wrk-segment-list" id="wrkSegmentList">
                            <div class="wrk-list-empty">
                                No segments yet — add one below
                            </div>
                        </div>
                        <div class="wrk-add-bar">
                            <button
                                class="btn btn-ghost wrk-add-btn"
                                onclick="wrkAddSegment('warmup')"
                            >
                                + Warmup
                            </button>
                            <button
                                class="btn btn-ghost wrk-add-btn"
                                onclick="wrkAddSegment('steady')"
                            >
                                + Steady
                            </button>
                            <button
                                class="btn btn-ghost wrk-add-btn"
                                onclick="wrkAddSegment('interval')"
                            >
                                + Interval
                            </button>
                            <button
                                class="btn btn-ghost wrk-add-btn"
                                onclick="wrkAddSegment('cooldown')"
                            >
                                + Cooldown
                            </button>
                            <button
                                class="btn btn-ghost wrk-add-btn"
                                onclick="wrkAddSegment('free')"
                            >
                                + Free Ride
                            </button>
                        </div>
                    </div>

                    <!-- Export bar -->
                    <div class="card wrk-export-card">
                        <div class="wrk-export-info">
                            <div class="wrk-export-title">Export workout</div>
                            <div class="wrk-export-sub">
                                Zwift: load the .zwo file from
                                Documents/Zwift/Workouts · Garmin: sideload the
                                .fit to your device or import via Garmin Connect
                            </div>
                        </div>
                        <div class="wrk-export-btns">
                            <button
                                class="btn btn-primary"
                                onclick="wrkExportZwo()"
                            >
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                                    />
                                    <polyline points="7 10 12 15 17 10" />
                                    <line x1="12" y1="15" x2="12" y2="3" />
                                </svg>
                                Zwift (.zwo)
                            </button>
                            <button
                                class="btn btn-ghost"
                                onclick="wrkExportFit()"
                            >
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                                    />
                                    <polyline points="7 10 12 15 17 10" />
                                    <line x1="12" y1="15" x2="12" y2="3" />
                                </svg>
                                Garmin (.fit)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ==================== TRAINING GUIDE PAGE ==================== -->
                <div class="page" id="page-guide">
                    <div id="guidePageContent">
                        <!-- populated by renderGuidePage() -->
                    </div>
                </div>

                <!-- ==================== WEATHER PAGE ==================== -->
                <div class="page" id="page-weather">
                    <div id="weatherPageContent">
                        <!-- Filled by renderWeatherPage() -->
                        <div class="wx-page-loading">
                            <div class="spinner"></div>
                            <p>Loading weather…</p>
                        </div>
                    </div>
                </div>

                <!-- ==================== GEAR PAGE ==================== -->
                <div class="page" id="page-gear">
                    <!-- Bikes from intervals.icu (shared across all tabs) -->
                    <div class="gear-section-header">
                        <div>
                            <div class="gear-section-title">Your Bikes</div>
                            <div class="gear-section-sub">Synced from intervals.icu</div>
                        </div>
                    </div>
                    <div class="gear-bikes-row" id="gearBikesRow">
                        <div class="gear-bikes-loading">
                            <div class="spinner"></div>
                            Loading bikes…
                        </div>
                    </div>

                    <!-- Gear tabs -->
                    <div class="imp-source-tabs" style="margin-top:20px">
                        <button class="imp-tab imp-tab--active" data-gear="components" onclick="gearSwitchTab('components')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            Components
                        </button>
                        <button class="imp-tab" data-gear="batteries" onclick="gearSwitchTab('batteries')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="6" y="4" width="12" height="18" rx="2"/><line x1="10" y1="1" x2="14" y2="1" stroke-width="3" stroke-linecap="round"/></svg>
                            Batteries
                        </button>
                        <button class="imp-tab" data-gear="service" onclick="gearSwitchTab('service')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                            Service
                        </button>
                    </div>

                    <!-- Components panel -->
                    <div class="gear-panel" id="gearPanelComponents">
                        <div class="gear-section-header">
                            <div>
                                <div class="gear-section-title" id="gearComponentsTitle">Components</div>
                                <div class="gear-section-sub" id="gearComponentsSub">Select a bike above to filter by bike</div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="openGearModal()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Add Component
                            </button>
                        </div>
                        <div id="gearComponentsGrid" class="gear-components-grid"></div>
                    </div>

                    <!-- Batteries panel -->
                    <div class="gear-panel" id="gearPanelBatteries" style="display:none">
                        <div class="gear-section-header">
                            <div>
                                <div class="gear-section-title" id="gearBatteriesTitle">Batteries</div>
                                <div class="gear-section-sub" id="gearBatteriesSub">Track electronic shifting battery levels</div>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center">
                                <label class="battery-toggle-obsolete" id="batteryObsoleteToggle" style="display:none">
                                    <input type="checkbox" id="batteryShowObsolete" onchange="renderGearBatteries()">
                                    <span>Show retired</span>
                                </label>
                                <button class="btn btn-primary btn-sm" onclick="openBatteryModal()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    Add Battery
                                </button>
                            </div>
                        </div>
                        <div id="gearBatteriesGrid" class="battery-grid"></div>
                    </div>

                    <!-- Service panel -->
                    <div class="gear-panel" id="gearPanelService" style="display:none">
                        <div class="gear-section-header">
                            <div>
                                <div class="gear-section-title" id="gearServiceTitle">Bike Service</div>
                                <div class="gear-section-sub" id="gearServiceSub">Track servicing history and upcoming maintenance</div>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center">
                                <button class="btn btn-ghost btn-sm" onclick="openServiceShopModal()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                    Shops
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="openServiceModal()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    Add Service
                                </button>
                            </div>
                        </div>
                        <div id="gearServiceGrid" class="service-grid"></div>
                    </div>
                </div>

                <!-- ==================== SETTINGS PAGE ==================== -->
                <div class="page" id="page-settings">
                    <div class="settings-grid">
                        <div class="settings-col">
                            <!-- moved to Import → intervals.icu tab:
                                 Connection, Profile, Data & Sync, Storage,
                                 Lifetime, Backup, Smart Sync, API Usage -->

                            <!-- Avatar (kept for Settings photo management) -->
                            <div class="card">
                                <div class="stt-section-header">
                                    <svg class="stt-section-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/>
                                    </svg>
                                    <div>
                                        <div class="stt-section-title">Profile Photo</div>
                                        <div class="stt-section-sub">Stored locally in your browser</div>
                                    </div>
                                </div>
                                <div class="stt-avatar-row">
                                    <div class="avatar-preview-wrap">
                                        <div
                                            class="avatar-preview"
                                            id="avatarPreview"
                                        >
                                            ?
                                        </div>
                                        <button
                                            class="avatar-edit-btn"
                                            onclick="
                                                document
                                                    .getElementById(
                                                        'avatarFileInput',
                                                    )
                                                    .click()
                                            "
                                            title="Change photo"
                                        >
                                            <svg
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2.5"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                            >
                                                <path
                                                    d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                                                />
                                                <path
                                                    d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                                                />
                                            </svg>
                                        </button>
                                        <input
                                            type="file"
                                            id="avatarFileInput"
                                            accept="image/*"
                                            style="display: none"
                                            onchange="handleAvatarUpload(event)"
                                        />
                                    </div>
                                    <div class="stt-avatar-info">
                                        <div
                                            class="stt-row-label"
                                            id="settingsAthleteName"
                                        >
                                            —
                                        </div>
                                        <div class="stt-row-sub">
                                            Auto-synced from intervals.icu · upload your own to override
                                        </div>
                                    </div>
                                    <button
                                        class="btn btn-ghost btn-sm"
                                        id="avatarRemoveBtn"
                                        onclick="removeAvatar()"
                                        style="display: none"
                                    >
                                        Remove
                                    </button>
                                </div>

                            </div>

                            <!-- Data & Sync card removed — now in Import → intervals.icu tab -->
                            <!-- DISPLAY -->
                            <div class="card">
                                <div class="stt-section-header">
                                    <svg
                                        class="stt-section-icon"
                                        width="18"
                                        height="18"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <rect
                                            x="2"
                                            y="3"
                                            width="20"
                                            height="14"
                                            rx="2"
                                        />
                                        <path d="M8 21h8M12 17v4" />
                                    </svg>
                                    <div>
                                        <div class="stt-section-title">
                                            Display
                                        </div>
                                        <div class="stt-section-sub">
                                            How data is shown
                                        </div>
                                    </div>
                                </div>
                                <div class="stt-rows">
                                    <div class="stt-row">
                                        <div class="stt-row-info">
                                            <div class="stt-row-label">Theme</div>
                                            <div class="stt-row-sub">Switch between dark and light appearance</div>
                                        </div>
                                        <div class="theme-toggle" id="themePills">
                                            <div class="theme-toggle-slider"></div>
                                            <button class="theme-toggle-btn active" data-theme-val="dark" onclick="setTheme('dark')">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                                                Dark
                                            </button>
                                            <button class="theme-toggle-btn" data-theme-val="light" onclick="setTheme('light')">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                                                Light
                                            </button>
                                        </div>
                                    </div>
                                    <div class="stt-row stt-row--toggle">
                                        <div class="stt-row-info">
                                            <div class="stt-row-label">
                                                Physics Scroll
                                            </div>
                                            <div class="stt-row-sub">
                                                Momentum-based drag scrolling
                                            </div>
                                        </div>
                                        <label class="settings-ios-toggle">
                                            <input
                                                type="checkbox"
                                                id="physicsScrollToggle"
                                                onchange="
                                                    setPhysicsScroll(
                                                        this.checked,
                                                    )
                                                "
                                            />
                                            <span
                                                class="settings-ios-slider"
                                            ></span>
                                        </label>
                                    </div>
                                    <div class="stt-row stt-row--toggle">
                                        <div class="stt-row-info">
                                            <div class="stt-row-label">
                                                Hide empty cards
                                            </div>
                                            <div class="stt-row-sub">
                                                Collapse activity cards with no
                                                data
                                            </div>
                                        </div>
                                        <label class="settings-ios-toggle">
                                            <input
                                                type="checkbox"
                                                id="hideEmptyCardsToggle"
                                                onchange="
                                                    setHideEmptyCards(
                                                        this.checked,
                                                    )
                                                "
                                            />
                                            <span
                                                class="settings-ios-slider"
                                            ></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- UNITS -->
                            <div class="card">
                                <div class="stt-section-header">
                                    <svg
                                        class="stt-section-icon"
                                        width="18"
                                        height="18"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <line x1="12" y1="2" x2="12" y2="22" />
                                        <path
                                            d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                                        />
                                    </svg>
                                    <div>
                                        <div class="stt-section-title">
                                            Units
                                        </div>
                                        <div class="stt-section-sub">
                                            Measurement system &amp; calendar
                                        </div>
                                    </div>
                                </div>
                                <div class="stt-rows">
                                    <div class="stt-row stt-row--control">
                                        <div class="stt-row-info">
                                            <div class="stt-row-label">
                                                Distance &amp; Speed
                                            </div>
                                            <div class="stt-row-sub">
                                                Elevation follows this setting ·
                                                currently
                                                <span id="settingsElevUnit"
                                                    >metres</span
                                                >
                                            </div>
                                        </div>
                                        <div class="date-range-pill">
                                            <button
                                                data-units="metric"
                                                onclick="setUnits('metric')"
                                            >
                                                km
                                            </button>
                                            <button
                                                data-units="imperial"
                                                onclick="setUnits('imperial')"
                                            >
                                                mi
                                            </button>
                                        </div>
                                    </div>
                                    <div class="stt-row stt-row--control">
                                        <div class="stt-row-info">
                                            <div class="stt-row-label">
                                                Week starts on
                                            </div>
                                            <div class="stt-row-sub">
                                                Affects weekly stats &amp;
                                                calendar view
                                            </div>
                                        </div>
                                        <div class="date-range-pill">
                                            <button
                                                data-weekstart="1"
                                                onclick="setWeekStartDay(1)"
                                                class="active"
                                            >
                                                Mon
                                            </button>
                                            <button
                                                data-weekstart="0"
                                                onclick="setWeekStartDay(0)"
                                            >
                                                Sun
                                            </button>
                                        </div>
                                    </div>
                                    <div class="stt-row stt-row--control">
                                        <div class="stt-row-info">
                                            <div class="stt-row-label">
                                                Default date range
                                            </div>
                                            <div class="stt-row-sub">
                                                Dashboard &amp; activities
                                                default view
                                            </div>
                                        </div>
                                        <div class="date-range-pill">
                                            <button
                                                data-defrange="7"
                                                onclick="setRange(7)"
                                            >
                                                7d
                                            </button>
                                            <button
                                                data-defrange="14"
                                                onclick="setRange(14)"
                                            >
                                                14d
                                            </button>
                                            <button
                                                data-defrange="30"
                                                onclick="setRange(30)"
                                                class="active"
                                            >
                                                30d
                                            </button>
                                            <button
                                                data-defrange="60"
                                                onclick="setRange(60)"
                                            >
                                                60d
                                            </button>
                                            <button
                                                data-defrange="90"
                                                onclick="setRange(90)"
                                            >
                                                90d
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- FONT -->
                            <div class="card">
                                <div class="stt-section-header">
                                    <svg class="stt-section-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="4 7 4 4 20 4 20 7" />
                                        <line x1="9" y1="20" x2="15" y2="20" />
                                        <line x1="12" y1="4" x2="12" y2="20" />
                                    </svg>
                                    <div>
                                        <div class="stt-section-title">Font</div>
                                        <div class="stt-section-sub">App typeface</div>
                                    </div>
                                </div>
                                <div class="font-picker" id="fontPicker">
                                    <button class="font-option" data-font="inter" onclick="setAppFont('inter')">
                                        <span class="font-preview" style="font-family:'Inter',sans-serif">Ag</span>
                                        <span class="font-option-label">Inter</span>
                                    </button>
                                    <button class="font-option" data-font="dm-sans" onclick="setAppFont('dm-sans')">
                                        <span class="font-preview" style="font-family:'DM Sans',sans-serif">Ag</span>
                                        <span class="font-option-label">DM Sans</span>
                                    </button>
                                    <button class="font-option" data-font="outfit" onclick="setAppFont('outfit')">
                                        <span class="font-preview" style="font-family:'Outfit',sans-serif">Ag</span>
                                        <span class="font-option-label">Outfit</span>
                                    </button>
                                    <button class="font-option" data-font="space-grotesk" onclick="setAppFont('space-grotesk')">
                                        <span class="font-preview" style="font-family:'Space Grotesk',sans-serif">Ag</span>
                                        <span class="font-option-label">Space Grotesk</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="settings-col">
                            <!-- MAP -->
                            <div class="card">
                                <div class="stt-section-header">
                                    <svg
                                        class="stt-section-icon"
                                        width="18"
                                        height="18"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <polygon
                                            points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"
                                        />
                                        <line x1="9" y1="3" x2="9" y2="18" />
                                        <line x1="15" y1="6" x2="15" y2="21" />
                                    </svg>
                                    <div>
                                        <div class="stt-section-title">Map</div>
                                        <div class="stt-section-sub">
                                            Activity route style
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="map-theme-picker"
                                    id="mapThemePicker"
                                >
                                    <button
                                        class="map-theme-option"
                                        data-theme="voyager"
                                        onclick="setMapTheme('voyager')"
                                    >
                                        <span
                                            class="map-theme-swatch"
                                            style="
                                                background: linear-gradient(
                                                    135deg,
                                                    #f0ede4 0%,
                                                    #d9d4c5 50%,
                                                    #b8cca0 100%
                                                );
                                            "
                                        ></span>
                                        <span class="map-theme-label"
                                            >Voyager</span
                                        >
                                    </button>
                                    <button
                                        class="map-theme-option"
                                        data-theme="light"
                                        onclick="setMapTheme('light')"
                                    >
                                        <span
                                            class="map-theme-swatch"
                                            style="
                                                background: linear-gradient(
                                                    135deg,
                                                    #f8f8f5 0%,
                                                    #ebebea 50%,
                                                    #d4d4cc 100%
                                                );
                                            "
                                        ></span>
                                        <span class="map-theme-label"
                                            >Light</span
                                        >
                                    </button>
                                    <button
                                        class="map-theme-option"
                                        data-theme="dark"
                                        onclick="setMapTheme('dark')"
                                    >
                                        <span
                                            class="map-theme-swatch"
                                            style="
                                                background: linear-gradient(
                                                    135deg,
                                                    #2a2d35 0%,
                                                    #1e2028 50%,
                                                    #14151a 100%
                                                );
                                            "
                                        ></span>
                                        <span class="map-theme-label"
                                            >Dark</span
                                        >
                                    </button>
                                    <button
                                        class="map-theme-option"
                                        data-theme="topo"
                                        onclick="setMapTheme('topo')"
                                    >
                                        <span
                                            class="map-theme-swatch"
                                            style="
                                                background: linear-gradient(
                                                    135deg,
                                                    #d4e8b8 0%,
                                                    #c8d8a0 50%,
                                                    #a8c870 100%
                                                );
                                            "
                                        ></span>
                                        <span class="map-theme-label"
                                            >Topo</span
                                        >
                                    </button>
                                    <button
                                        class="map-theme-option"
                                        data-theme="outdoors"
                                        onclick="setMapTheme('outdoors')"
                                    >
                                        <span
                                            class="map-theme-swatch"
                                            style="
                                                background: linear-gradient(
                                                    135deg,
                                                    #e8f0e4 0%,
                                                    #d8e8d4 50%,
                                                    #b8d4b8 100%
                                                );
                                            "
                                        ></span>
                                        <span class="map-theme-label"
                                            >Streets</span
                                        >
                                    </button>
                                </div>
                                <div class="stt-rows" style="margin-top: 8px">
                                    <div class="stt-row stt-row--toggle">
                                        <div class="stt-row-info">
                                            <div class="stt-row-label">
                                                Smooth flyover
                                            </div>
                                            <div class="stt-row-sub">
                                                Fluid marker movement between
                                                GPS points
                                            </div>
                                        </div>
                                        <label class="settings-ios-toggle">
                                            <input
                                                type="checkbox"
                                                id="smoothFlyoverToggle"
                                                onchange="
                                                    toggleSmoothFlyover(
                                                        this.checked,
                                                    )
                                                "
                                            />
                                            <span
                                                class="settings-ios-slider"
                                            ></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- WEATHER -->
                            <div class="card">
                                <div class="stt-section-header">
                                    <svg
                                        class="stt-section-icon"
                                        width="18"
                                        height="18"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <path
                                            d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"
                                        />
                                    </svg>
                                    <div>
                                        <div class="stt-section-title">
                                            Weather
                                        </div>
                                        <div class="stt-section-sub">
                                            Riding forecast on dashboard
                                        </div>
                                    </div>
                                </div>
                                <div class="stt-rows">
                                    <div class="stt-row stt-row--control">
                                        <div class="stt-row-info">
                                            <div class="stt-row-label">
                                                Add location
                                            </div>
                                            <div
                                                class="stt-row-sub"
                                                id="wxCurrentLocation"
                                            >
                                                Up to 5 locations
                                            </div>
                                        </div>
                                        <div class="wx-location-input-row">
                                            <input
                                                type="text"
                                                id="wxCityInput"
                                                class="wx-city-input"
                                                placeholder="e.g. Ljubljana"
                                                autocomplete="off"
                                            />
                                            <button
                                                class="btn btn-primary btn-sm"
                                                onclick="setWeatherCity()"
                                            >
                                                Add
                                            </button>
                                            <button
                                                class="btn btn-ghost btn-sm"
                                                onclick="useMyLocation()"
                                                title="Use browser location"
                                            >
                                                <svg
                                                    viewBox="0 0 24 24"
                                                    width="14"
                                                    height="14"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    stroke-width="2"
                                                >
                                                    <circle
                                                        cx="12"
                                                        cy="12"
                                                        r="3"
                                                    />
                                                    <path
                                                        d="M12 2v3m0 14v3M2 12h3m14 0h3"
                                                    />
                                                    <circle
                                                        cx="12"
                                                        cy="12"
                                                        r="8"
                                                    />
                                                </svg>
                                                Locate me
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Saved locations list -->
                                    <div id="wxLocationsList"></div>
                                    <div class="stt-row stt-row--control">
                                        <div class="stt-row-info">
                                            <div class="stt-row-label">
                                                Forecast model
                                            </div>
                                            <div class="stt-row-sub">
                                                Best match auto-selects
                                                highest-res for your region
                                            </div>
                                        </div>
                                        <select
                                            id="wxModelSelect"
                                            class="app-select app-select--sm"
                                            onchange="
                                                setWeatherModel(this.value)
                                            "
                                        >
                                            <option value="best_match">
                                                Best match (auto)
                                            </option>
                                            <option value="icon_seamless">
                                                ICON — DWD (Europe)
                                            </option>
                                            <option value="ecmwf_ifs04">
                                                ECMWF IFS (global)
                                            </option>
                                            <option value="gfs_seamless">
                                                GFS — NOAA (global)
                                            </option>
                                            <option
                                                value="meteofrance_seamless"
                                            >
                                                Météo-France (Europe)
                                            </option>
                                            <option value="gem_seamless">
                                                GEM — Canada (global)
                                            </option>
                                            <option value="metno_seamless">
                                                MET Norway (Scandinavia)
                                            </option>
                                            <option value="jma_seamless">
                                                JMA (Japan/Asia)
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="stt-actions">
                                    <button
                                        class="btn btn-ghost"
                                        onclick="clearWeatherLocation()"
                                    >
                                        <svg
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                        >
                                            <polyline points="3 6 5 6 21 6" />
                                            <path d="M19 6l-1 14H6L5 6" />
                                            <path d="M10 11v6" />
                                            <path d="M14 11v6" />
                                            <path d="M9 6V4h6v2" />
                                        </svg>
                                        Clear Location
                                    </button>
                                </div>
                            </div>

                            <!-- DASHBOARD SECTIONS -->
                            <div class="card">
                                <div class="stt-section-header">
                                    <svg
                                        class="stt-section-icon"
                                        width="18"
                                        height="18"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <rect
                                            x="3"
                                            y="3"
                                            width="7"
                                            height="7"
                                        />
                                        <rect
                                            x="14"
                                            y="3"
                                            width="7"
                                            height="7"
                                        />
                                        <rect
                                            x="3"
                                            y="14"
                                            width="7"
                                            height="7"
                                        />
                                        <rect
                                            x="14"
                                            y="14"
                                            width="7"
                                            height="7"
                                        />
                                    </svg>
                                    <div>
                                        <div class="stt-section-title">
                                            Dashboard Sections
                                        </div>
                                        <div class="stt-section-sub">
                                            Show or hide cards on the dashboard
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="stt-rows"
                                    id="dashSectionToggles"
                                ></div>
                            </div>

                            <!-- SHARE -->
                            <div class="card">
                                <div class="stt-section-header">
                                    <svg class="stt-section-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                                    </svg>
                                    <div>
                                        <div class="stt-section-title">Share CycleIQ</div>
                                        <div class="stt-section-sub">Help other cyclists discover the app</div>
                                    </div>
                                </div>
                                <div class="stt-share-box">
                                    <p class="stt-share-text">Enjoying CycleIQ? Share it with your riding buddies and help the community grow.</p>
                                    <div class="stt-share-link-row">
                                        <input type="text" class="stt-input stt-share-input" id="shareLink" value="https://cycleiq.app" readonly />
                                        <button class="btn btn-accent btn-sm" id="shareCopyBtn" onclick="copyShareLink()">Copy</button>
                                    </div>
                                    <div class="stt-share-socials">
                                        <button class="stt-social-btn" onclick="shareToTwitter()" title="Share on X">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                                        </button>
                                        <button class="stt-social-btn" onclick="shareToWhatsApp()" title="Share on WhatsApp">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                        </button>
                                        <button class="stt-social-btn" onclick="shareToReddit()" title="Share on Reddit">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- DONATE -->
                            <div class="card">
                                <div class="stt-section-header">
                                    <svg class="stt-section-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                                    </svg>
                                    <div>
                                        <div class="stt-section-title">Support CycleIQ</div>
                                        <div class="stt-section-sub">Open source & free forever</div>
                                    </div>
                                </div>
                                <div class="stt-donate-box">
                                    <p class="stt-share-text">CycleIQ is open source and completely free. If you find it useful, consider buying us a coffee to support development.</p>
                                    <a href="https://buymeacoffee.com/cycleiq" target="_blank" rel="noopener" class="stt-donate-btn">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/>
                                        </svg>
                                        Buy me a coffee
                                    </a>
                                    <a href="https://github.com/cycleiq/cycleiq" target="_blank" rel="noopener" class="stt-github-btn">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                                        Star on GitHub
                                    </a>
                                </div>
                            </div>

                            <!-- ABOUT -->
                            <div class="stt-about">
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    width="14"
                                    height="14"
                                >
                                    <circle cx="12" cy="12" r="10" />
                                    <line x1="12" y1="16" x2="12" y2="12" />
                                    <line x1="12" y1="8" x2="12.01" y2="8" />
                                </svg>
                                CycleIQ pulls data directly from intervals.icu.
                                Your API key is stored only in your browser and
                                never transmitted elsewhere. No backend, no
                                accounts — just your data.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== GOALS & STREAKS PAGE ==================== -->
                <div class="page" id="page-goals">
                    <!-- Streaks section -->
                    <div id="goalsStreaksSection">
                        <!-- Hero: current week streak -->
                        <div class="stk-hero-row">
                            <div class="stk-hero-card" id="stkWeekHero">
                                <div class="stk-hero-flame">🔥</div>
                                <div class="stk-hero-num" id="stkWeekNum">
                                    —
                                </div>
                                <div class="stk-hero-label">Week Streak</div>
                                <div class="stk-hero-sub" id="stkWeekSub">
                                    consecutive weeks active
                                </div>
                            </div>
                            <div
                                class="stk-hero-card stk-hero-card--day"
                                id="stkDayHero"
                            >
                                <div class="stk-hero-flame">⚡</div>
                                <div class="stk-hero-num" id="stkDayNum">—</div>
                                <div class="stk-hero-label">Day Streak</div>
                                <div class="stk-hero-sub" id="stkDaySub">
                                    consecutive days active
                                </div>
                            </div>
                            <div
                                class="stk-hero-card stk-hero-card--month"
                                id="stkMonthHero"
                            >
                                <div class="stk-hero-flame">📅</div>
                                <div class="stk-hero-num" id="stkMonthNum">
                                    —
                                </div>
                                <div class="stk-hero-label">Month Streak</div>
                                <div class="stk-hero-sub" id="stkMonthSub">
                                    consecutive months active
                                </div>
                            </div>
                        </div>

                        <!-- Week calendar heatmap -->
                        <div class="card stk-cal-card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        Weekly Activity Calendar
                                    </div>
                                    <div class="card-subtitle" id="stkCalSub">
                                        Last 52 weeks
                                    </div>
                                </div>
                                <div class="stk-cal-legend">
                                    <span class="stk-leg-dot stk-leg-0"></span>
                                    <span class="stk-leg-label">Rest</span>
                                    <span class="stk-leg-dot stk-leg-1"></span>
                                    <span class="stk-leg-label">Light</span>
                                    <span class="stk-leg-dot stk-leg-2"></span>
                                    <span class="stk-leg-label">Active</span>
                                    <span class="stk-leg-dot stk-leg-3"></span>
                                    <span class="stk-leg-label">Heavy</span>
                                </div>
                            </div>
                            <div class="stk-cal-wrap" id="stkCalWrap"></div>
                        </div>

                        <!-- Personal bests row -->
                        <div class="stk-pb-row">
                            <div class="card stk-pb-card">
                                <div class="stk-pb-icon">🏆</div>
                                <div class="stk-pb-val" id="stkBestWeekStreak">
                                    —
                                </div>
                                <div class="stk-pb-label">Best Week Streak</div>
                                <div class="stk-pb-sub" id="stkBestWeekSub">
                                    all time
                                </div>
                            </div>
                            <div class="card stk-pb-card">
                                <div class="stk-pb-icon">⚡</div>
                                <div class="stk-pb-val" id="stkBestDayStreak">
                                    —
                                </div>
                                <div class="stk-pb-label">Best Day Streak</div>
                                <div class="stk-pb-sub" id="stkBestDaySub">
                                    all time
                                </div>
                            </div>
                            <div class="card stk-pb-card">
                                <div class="stk-pb-icon">📆</div>
                                <div class="stk-pb-val" id="stkBestMonthStreak">
                                    —
                                </div>
                                <div class="stk-pb-label">
                                    Best Month Streak
                                </div>
                                <div class="stk-pb-sub" id="stkBestMonthSub">
                                    all time
                                </div>
                            </div>
                            <div class="card stk-pb-card">
                                <div class="stk-pb-icon">🚴</div>
                                <div class="stk-pb-val" id="stkTotalWeeks">
                                    —
                                </div>
                                <div class="stk-pb-label">Active Weeks</div>
                                <div class="stk-pb-sub">
                                    weeks with at least 1 ride
                                </div>
                            </div>
                        </div>

                        <!-- This year monthly breakdown -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title" id="stkYearTitle">
                                        This Year
                                    </div>
                                    <div class="card-subtitle" id="stkYearSub">
                                        Rides per month
                                    </div>
                                </div>
                                <div
                                    class="stk-year-total"
                                    id="stkYearTotal"
                                ></div>
                            </div>
                            <div
                                class="stk-months-grid"
                                id="stkMonthsGrid"
                            ></div>
                        </div>

                        <!-- Badges / achievements -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Achievements</div>
                                    <div class="card-subtitle">
                                        Milestones unlocked through consistency
                                    </div>
                                </div>
                            </div>
                            <div
                                class="stk-badges-grid"
                                id="stkBadgesGrid"
                            ></div>
                        </div>

                        <!-- Fun lifetime stats -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Lifetime Stats</div>
                                    <div
                                        class="card-subtitle"
                                        id="stkLifetimeSub"
                                    >
                                        Everything you've ever done on the bike
                                    </div>
                                </div>
                            </div>
                            <div
                                class="stk-lifetime-grid"
                                id="stkLifetimeGrid"
                            ></div>
                        </div>
                    </div>

                    <!-- Goals section -->
                    <div id="goalsPageContent"></div>
                </div>

                <!-- ==================== HEAT MAP PAGE ==================== -->
                <div class="page" id="page-heatmap">
                    <div id="heatmapPageContent"></div>
                </div>

                <!-- ==================== COMPARE PAGE ==================== -->
                <div class="page" id="page-compare">
                    <!-- Control Panel -->
                    <div class="compare-control-panel">
                        <!-- Period & Grouping Section -->
                        <div class="compare-period-section">
                            <!-- Period Selector -->
                            <div class="compare-period-selector">
                                <label>Time Period</label>
                                <div class="compare-range-pills">
                                    <button
                                        onclick="setComparePeriod(28)"
                                        class="active"
                                    >
                                        4 Weeks
                                    </button>
                                    <button onclick="setComparePeriod(84)">
                                        12 Weeks
                                    </button>
                                    <button onclick="setComparePeriod(182)">
                                        6 Months
                                    </button>
                                    <button onclick="setComparePeriod(365)">
                                        1 Year
                                    </button>
                                </div>
                            </div>

                            <!-- Time Grouping Dropdown -->
                            <div class="compare-grouping-selector">
                                <label>Group By</label>
                                <select
                                    id="compareGrouping"
                                    class="app-select app-select--sm"
                                    onchange="updateComparePage()"
                                >
                                    <option value="week" selected>
                                        Weekly
                                    </option>
                                    <option value="biweek">Bi-weekly</option>
                                    <option value="month">Monthly</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Metrics Container -->
                    <div
                        class="compare-metrics-container"
                        id="compareMetricsContainer"
                    ></div>

                    <!-- Add Card Button -->
                    <button
                        class="btn btn-primary"
                        style="margin: 20px var(--pad-page)"
                        onclick="addCompareCard()"
                    >
                        + Add Metric
                    </button>

                    <!-- Empty State -->
                    <div class="empty-state" id="compareEmptyState">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="1.5"
                        >
                            <path
                                d="M3 3v18h18M3 9h12M3 15h18M9 3v18M15 3v18"
                            />
                        </svg>
                        <p>
                            Click "Add Metric" to start comparing your training
                            data
                        </p>
                    </div>
                </div>

                <!-- ==================== IMPORT PAGE ==================== -->
                <div class="page" id="page-import">
                    <!-- Source tabs -->
                    <div class="imp-source-tabs">
                        <button class="imp-tab imp-tab--active" data-src="icu" onclick="impSwitchTab('icu')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                            </svg>
                            intervals.icu
                        </button>
                        <button class="imp-tab" data-src="fit" onclick="impSwitchTab('fit')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                            FIT File
                        </button>
                        <button class="imp-tab" data-src="strava" onclick="impSwitchTab('strava')">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/>
                            </svg>
                            Strava
                        </button>
                    </div>

                    <!-- intervals.icu Panel -->
                    <div class="imp-panel" id="impPanelIcu">
                        <!-- Not Connected -->
                        <div class="card" id="icuConnectCard">
                            <div class="icu-connect-header">
                                <svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                </svg>
                                <div class="icu-connect-title">Connect to intervals.icu</div>
                                <div class="icu-connect-sub">Sync your training data, power curves & fitness metrics</div>
                            </div>
                            <div class="stt-rows">
                                <div class="stt-row">
                                    <span class="stt-row-label">Athlete ID</span>
                                    <input type="text" class="stt-input" id="icuAthleteIdInput" placeholder="e.g. i12345">
                                </div>
                                <div class="stt-row">
                                    <span class="stt-row-label">API Key</span>
                                    <div style="display:flex;align-items:center;gap:6px;flex:1;justify-content:flex-end">
                                        <input type="password" class="stt-input" id="icuApiKeyInput" placeholder="Your intervals.icu API key">
                                        <button class="btn btn-ghost btn-sm" onclick="let i=document.getElementById('icuApiKeyInput');i.type=i.type==='password'?'text':'password'" title="Show/hide" style="padding:4px 6px">
                                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="icu-connect-help">
                                Go to <a href="https://intervals.icu" target="_blank" rel="noopener">intervals.icu</a> → Settings → API to find your <strong>Athlete ID</strong> (starts with <code>i</code>) and <strong>API Key</strong>.
                            </div>
                            <div class="stt-actions">
                                <button class="btn btn-primary" onclick="icuSaveAndConnect()">
                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:6px">
                                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                    </svg>
                                    Connect &amp; Sync
                                </button>
                            </div>
                        </div>

                        <!-- Connected -->
                        <div class="card" id="icuSyncCard" style="display:none">
                            <!-- Header -->
                            <div class="stt-section-header">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                </svg>
                                <div>
                                    <div class="stt-section-title" id="icuAthleteTitle">Connected to intervals.icu</div>
                                    <div class="stt-section-sub" id="icuLastSync">Never synced</div>
                                </div>
                                <div class="connection-status-badge connected" id="icuConnectionBadge">
                                    <span id="icuConnectionText">Connected</span>
                                </div>
                            </div>

                            <!-- Profile -->
                            <div class="stt-rows">
                                <div class="stt-row"><span class="stt-row-label">Athlete ID</span><span class="stt-row-value" id="icuAthleteId">—</span></div>
                                <div class="stt-row"><span class="stt-row-label">FTP</span><span class="stt-row-value" id="icuFTP">—</span></div>
                                <div class="stt-row"><span class="stt-row-label">LTHR</span><span class="stt-row-value" id="icuLTHR">—</span></div>
                                <div class="stt-row"><span class="stt-row-label">Weight</span><span class="stt-row-value" id="icuWeight">—</span></div>
                            </div>

                            <!-- Sync Actions -->
                            <div class="stt-actions" style="gap:8px">
                                <button class="btn btn-primary" onclick="confirmSyncData()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-.08-8.58"/></svg>
                                    Sync Now
                                </button>
                                <button class="btn btn-ghost" onclick="confirmFullResync()">Full Re-sync</button>
                                <button class="btn btn-ghost" onclick="openModal()">Change Credentials</button>
                                <button class="btn btn-danger" onclick="disconnect()">Disconnect</button>
                            </div>

                            <!-- Data & Cache -->
                            <div class="stt-subsection-divider"></div>
                            <div class="stt-subsection-header">
                                <svg class="stt-section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
                                    <line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/>
                                </svg>
                                <span class="stt-subsection-title">Data &amp; Storage</span>
                            </div>
                            <div class="stt-rows">
                                <div class="stt-row"><span class="stt-row-label">Last synced</span><span class="stt-row-value" id="icuSettingsLastSync">—</span></div>
                                <div class="stt-row"><span class="stt-row-label">Cached activities</span><span class="stt-row-value" id="icuActivityCount">—</span></div>
                                <div class="stt-row"><span class="stt-row-label">Cache size</span><span class="stt-row-value" id="icuCacheSize">—</span></div>
                            </div>
                            <div class="stg-bar-wrap">
                                <div class="stg-bar-track" id="storageBarTrack"></div>
                                <div class="stg-bar-label" id="storageBarLabel">— / 5.0 MB</div>
                                <div class="stg-bar-legend" id="storageBarLegend"></div>
                            </div>

                            <!-- Lifetime -->
                            <div class="stt-subsection-divider"></div>
                            <div class="stt-subsection-header">
                                <svg class="stt-section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                                </svg>
                                <span class="stt-subsection-title">Lifetime Data</span>
                            </div>
                            <div class="stt-rows">
                                <div class="stt-row"><span class="stt-row-label">Stored activities</span><span class="stt-row-value" id="icuLifetimeCount">—</span></div>
                                <div class="stt-row"><span class="stt-row-label">Cache size</span><span class="stt-row-value" id="icuLifetimeSize">—</span></div>
                                <div class="stt-row"><span class="stt-row-label">Last synced</span><span class="stt-row-value" id="icuLifetimeSync">—</span></div>
                            </div>
                            <div class="stt-actions">
                                <button class="btn btn-primary" onclick="resyncLifetimeData()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-.08-8.58"/></svg>
                                    Re-sync All
                                </button>
                                <button class="btn btn-ghost" onclick="showConfirmDialog('Clear Lifetime Cache','This will remove your cached lifetime activity data. It will be re-downloaded on next sync.',()=>{clearLifetimeCache();icuRenderSyncUI();updateStorageBar();showToast('Lifetime cache cleared','success')})">Clear Cache</button>
                                <button class="btn btn-ghost" onclick="clearAllCaches()">Clear All Caches</button>
                            </div>

                            <!-- Backup & Restore -->
                            <div class="stt-subsection-divider"></div>
                            <div class="stt-subsection-header">
                                <svg class="stt-section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                    <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                                </svg>
                                <span class="stt-subsection-title">Backup &amp; Restore</span>
                            </div>
                            <div class="stt-actions">
                                <button class="btn btn-primary" onclick="exportLifetimeJSON()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    Export JSON
                                </button>
                                <button class="btn btn-ghost" onclick="importLifetimeJSON()">Import JSON</button>
                                <button class="btn btn-ghost" onclick="copySetupLink()">Copy Setup Link</button>
                            </div>

                            <!-- Smart Sync -->
                            <div class="stt-subsection-divider"></div>
                            <div class="stt-subsection-header">
                                <svg class="stt-section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-.08-8.58"/>
                                </svg>
                                <span class="stt-subsection-title">Smart Sync</span>
                            </div>
                            <div class="stt-rows">
                                <div class="stt-row stt-row--toggle">
                                    <div class="stt-row-info">
                                        <div class="stt-row-label">Auto-sync</div>
                                        <div class="stt-row-sub">Checks for new rides while you're browsing</div>
                                    </div>
                                    <label class="settings-ios-toggle">
                                        <input type="checkbox" id="icuSmartPollToggle" onchange="setSmartPoll(this.checked)"/>
                                        <span class="settings-ios-slider"></span>
                                    </label>
                                </div>
                                <div class="stt-row stt-row--control" id="icuSmartPollIntervalRow" style="display:none">
                                    <div class="stt-row-info">
                                        <div class="stt-row-label">Check every</div>
                                        <div class="stt-row-sub">Only polls when tab is active</div>
                                    </div>
                                    <div class="date-range-pill" id="icuSmartPollIntervalPills">
                                        <button data-poll="5" onclick="setSmartPollInterval(5)">5m</button>
                                        <button data-poll="10" onclick="setSmartPollInterval(10)">10m</button>
                                        <button data-poll="15" onclick="setSmartPollInterval(15)" class="active">15m</button>
                                        <button data-poll="30" onclick="setSmartPollInterval(30)">30m</button>
                                    </div>
                                </div>
                                <div class="stt-row" id="icuSmartPollStatusRow" style="display:none">
                                    <span class="stt-row-label">Status</span>
                                    <span class="stt-row-value" id="icuSmartPollStatus">Idle</span>
                                </div>
                                <div class="stt-row" id="icuSmartPollLastRow" style="display:none">
                                    <span class="stt-row-label">Last checked</span>
                                    <span class="stt-row-value" id="icuSmartPollLastCheck">—</span>
                                </div>
                            </div>

                            <!-- API Usage -->
                            <div class="stt-subsection-divider"></div>
                            <div class="stt-subsection-header">
                                <svg class="stt-section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                                </svg>
                                <span class="stt-subsection-title">API Usage</span>
                            </div>
                            <div class="rl-bar-wrap">
                                <div class="rl-bar-header">
                                    <span class="rl-bar-used" id="rlBarUsed">0</span>
                                    <span class="rl-bar-label"> / 200 requests</span>
                                    <span class="rl-bar-window" id="rlBarWindow">per 15 min</span>
                                </div>
                                <div class="rl-bar-track"><div class="rl-bar-fill" id="rlBarFill" style="width:0%"></div></div>
                                <div class="rl-bar-footer">
                                    <span class="rl-bar-hint" id="rlBarHint">No requests tracked yet</span>
                                    <span class="rl-bar-reset" id="rlBarReset"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FIT Upload Panel -->
                    <div class="imp-panel" id="impPanelFit" style="display:none">
                        <!-- Drop zone -->
                        <div class="imp-dropzone" id="impDropzone">
                            <div class="imp-dropzone-icon">
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <path
                                        d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                                    />
                                    <polyline points="17 8 12 3 7 8" />
                                    <line x1="12" y1="3" x2="12" y2="15" />
                                </svg>
                            </div>
                            <div class="imp-dropzone-title">
                                Drop .FIT files here
                            </div>
                            <div class="imp-dropzone-sub">
                                or click to browse — supports multi-file upload
                            </div>
                            <input
                                type="file"
                                id="impFileInput"
                                accept=".fit,.FIT"
                                multiple
                                hidden
                            />
                            <div class="imp-dropzone-formats">
                                <span>Garmin</span><span>Wahoo</span
                                ><span>Polar</span><span>Suunto</span
                                ><span>Zwift</span>
                            </div>
                        </div>

                        <!-- Upload queue -->
                        <div
                            class="imp-queue-card card"
                            id="impQueueCard"
                            style="display: none"
                        >
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Upload Queue</div>
                                    <div class="card-subtitle" id="impQueueSub">
                                        0 files selected
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px">
                                    <button
                                        class="btn btn-ghost btn-sm"
                                        onclick="impClearQueue()"
                                    >
                                        Clear
                                    </button>
                                    <button
                                        class="btn btn-primary btn-sm"
                                        id="impProcessBtn"
                                        onclick="impProcessAll()"
                                    >
                                        <svg
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2.5"
                                            width="14"
                                            height="14"
                                        >
                                            <polyline points="20 6 9 17 4 12" />
                                        </svg>
                                        Import All
                                    </button>
                                </div>
                            </div>
                            <div class="imp-queue-list" id="impQueueList"></div>
                        </div>

                        <!-- Import options card -->
                        <div class="card" style="margin-top: var(--gap-layout)">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Import Options</div>
                                    <div class="card-subtitle">
                                        Customize how activities are processed
                                    </div>
                                </div>
                            </div>

                            <div class="imp-options-grid">
                                <label class="imp-toggle-row">
                                    <span class="imp-toggle-label">
                                        <svg
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            width="16"
                                            height="16"
                                        >
                                            <path
                                                d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"
                                            />
                                            <circle cx="12" cy="10" r="3" />
                                        </svg>
                                        Extract GPS routes
                                    </span>
                                    <span class="imp-toggle-hint"
                                        >Save route data for Heat Map</span
                                    >
                                    <input
                                        type="checkbox"
                                        id="impOptGPS"
                                        checked
                                    />
                                    <span class="imp-toggle-switch"></span>
                                </label>
                                <label class="imp-toggle-row">
                                    <span class="imp-toggle-label">
                                        <svg
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            width="16"
                                            height="16"
                                        >
                                            <circle cx="12" cy="12" r="10" />
                                            <path d="M12 6v6l4 2" />
                                        </svg>
                                        Auto-detect sport type
                                    </span>
                                    <span class="imp-toggle-hint"
                                        >Ride, Run, Swim based on file
                                        data</span
                                    >
                                    <input
                                        type="checkbox"
                                        id="impOptSport"
                                        checked
                                    />
                                    <span class="imp-toggle-switch"></span>
                                </label>
                                <label class="imp-toggle-row">
                                    <span class="imp-toggle-label">
                                        <svg
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            width="16"
                                            height="16"
                                        >
                                            <path d="M4 4h16v16H4z" />
                                            <path d="M4 9h16M9 4v16" />
                                        </svg>
                                        Skip duplicates
                                    </span>
                                    <span class="imp-toggle-hint"
                                        >Skip files already imported (by date +
                                        duration)</span
                                    >
                                    <input
                                        type="checkbox"
                                        id="impOptDupes"
                                        checked
                                    />
                                    <span class="imp-toggle-switch"></span>
                                </label>
                                <label class="imp-toggle-row">
                                    <span class="imp-toggle-label">
                                        <svg
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            width="16"
                                            height="16"
                                        >
                                            <path d="M12 20h9" />
                                            <path
                                                d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                                            />
                                        </svg>
                                        Allow renaming
                                    </span>
                                    <span class="imp-toggle-hint"
                                        >Edit activity name before
                                        importing</span
                                    >
                                    <input type="checkbox" id="impOptRename" />
                                    <span class="imp-toggle-switch"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Import history card -->
                        <div class="card" style="margin-top: var(--gap-layout)">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Import History</div>
                                    <div
                                        class="card-subtitle"
                                        id="impHistorySub"
                                    >
                                        No imports yet
                                    </div>
                                </div>
                                <button
                                    class="btn btn-ghost btn-sm"
                                    id="impHistoryClearBtn"
                                    onclick="impClearHistory()"
                                    style="display: none"
                                >
                                    Clear History
                                </button>
                            </div>
                            <div id="impHistoryList" class="imp-history-list">
                                <div class="imp-history-empty">
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="1.5"
                                        width="32"
                                        height="32"
                                    >
                                        <path
                                            d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                                        />
                                        <polyline points="14 2 14 8 20 8" />
                                        <line x1="16" y1="13" x2="8" y2="13" />
                                        <line x1="16" y1="17" x2="8" y2="17" />
                                    </svg>
                                    <p>Imported activities will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end FIT panel -->

                    <!-- Strava panel -->
                    <div class="imp-panel" id="impPanelStrava" style="display: none">
                        <!-- Not Connected -->
                        <div class="card" id="stravaConnectCard">
                            <div class="strava-connect-header">
                                <svg viewBox="0 0 24 24" width="40" height="40" fill="var(--orange)">
                                    <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/>
                                </svg>
                                <div class="strava-connect-title">Connect to Strava</div>
                                <div class="strava-connect-sub">Import activities, GPS routes, power & heart rate data</div>
                            </div>
                            <div class="stt-rows">
                                <div class="stt-row">
                                    <span class="stt-row-label">Client ID</span>
                                    <input type="text" class="stt-input" id="stravaClientId" placeholder="Your Strava API Client ID">
                                </div>
                                <div class="stt-row">
                                    <span class="stt-row-label">Client Secret</span>
                                    <input type="password" class="stt-input" id="stravaClientSecret" placeholder="Your Strava API Client Secret">
                                </div>
                            </div>
                            <div class="strava-connect-help">
                                Create an app at <a href="https://www.strava.com/settings/api" target="_blank" rel="noopener">strava.com/settings/api</a> to get your Client ID and Secret. Set the Authorization Callback Domain to <code id="stravaCallbackDomain">localhost</code>.
                            </div>
                            <div class="stt-actions">
                                <button class="btn btn-primary" onclick="stravaSaveAndAuth()">
                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right:6px"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
                                    Connect with Strava
                                </button>
                            </div>
                        </div>

                        <!-- Connected -->
                        <div class="card" id="stravaSyncCard" style="display:none">
                            <div class="stt-section-header">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="var(--orange)">
                                    <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/>
                                </svg>
                                <div>
                                    <div class="stt-section-title" id="stravaAthleteTitle">Connected to Strava</div>
                                    <div class="stt-section-sub" id="stravaLastSync">Never synced</div>
                                </div>
                                <div class="connection-status-badge connected">
                                    <span>Connected</span>
                                </div>
                            </div>

                            <div class="imp-options">
                                <label class="imp-toggle-row">
                                    <span>Import GPS routes</span>
                                    <input type="checkbox" id="stravaOptGPS" checked>
                                </label>
                                <label class="imp-toggle-row">
                                    <span>Import streams (power, HR, cadence)</span>
                                    <input type="checkbox" id="stravaOptStreams" checked>
                                </label>
                                <label class="imp-toggle-row">
                                    <span>Skip duplicates</span>
                                    <input type="checkbox" id="stravaOptDupes" checked>
                                </label>
                            </div>

                            <div class="stt-actions" style="gap:8px">
                                <button class="btn btn-primary" id="stravaSyncBtn" onclick="stravaSyncActivities()">Sync New Activities</button>
                                <button class="btn btn-ghost" onclick="stravaSyncActivities({fullSync:true})">Full Sync</button>
                                <button class="btn btn-ghost" onclick="stravaClearActivities()" style="margin-left:auto">Clear Data</button>
                                <button class="btn btn-danger" onclick="stravaDisconnect()">Disconnect</button>
                            </div>

                            <div class="strava-progress" id="stravaProgress" style="display:none">
                                <div class="strava-progress-bar">
                                    <div class="strava-progress-fill" id="stravaProgressFill"></div>
                                </div>
                                <div class="strava-progress-text" id="stravaProgressText">Syncing...</div>
                                <button class="btn btn-ghost btn-sm" onclick="stravaCancelSync()">Cancel</button>
                            </div>

                            <div class="imp-history-header">
                                <div class="imp-history-title">Sync History</div>
                                <div class="imp-history-sub" id="stravaSyncHistorySub">No syncs yet</div>
                            </div>
                            <div class="imp-history-list" id="stravaSyncHistoryList"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page-content -->
        </main>

        <!-- LOADING OVERLAY -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Syncing data…</div>
        </div>

        <!-- TOAST -->
        <div class="toast-container" id="toastContainer"></div>
    </body>
</html>
